<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Dein Weg ‚Äì Bildung & soziale Gerechtigkeit</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#121a33;
      --panel2:#0f1630;
      --text:#e8ecff;
      --muted:#aab3da;
      --accent:#6ee7ff;
      --danger:#ff6b6b;
      --ok:#71f7b7;
      --warn:#ffd166;
      --border: rgba(255,255,255,.12);
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    body.light-mode {
      --bg: #f0f4ff;
      --panel: #ffffff;
      --panel2: #f5f8ff;
      --text: #1a2040;
      --muted: #5a6490;
      --accent: #1a7fa8;
      --danger: #d63030;
      --ok: #1a9a60;
      --warn: #b07a00;
      --border: rgba(0,0,0,.12);
      --shadow: 0 8px 30px rgba(0,0,0,.12);
    }
    body.light-mode {
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(110,200,255,.12), transparent 60%),
        radial-gradient(800px 600px at 80% 0%, rgba(255,209,102,.10), transparent 60%),
        #f0f4ff;
    }
    /* Achievement Toast */
    .ach-toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: linear-gradient(135deg, rgba(30,40,80,.97), rgba(20,30,60,.97));
      border: 1px solid rgba(255,209,102,.4);
      border-radius: 16px;
      padding: 14px 20px;
      font-size: 14px;
      color: var(--warn);
      font-weight: 600;
      z-index: 1000;
      box-shadow: 0 8px 30px rgba(0,0,0,.4);
      transition: transform .4s cubic-bezier(.34,1.56,.64,1), opacity .3s;
      opacity: 0;
      white-space: nowrap;
      pointer-events: none;
      max-width: 90vw;
    }
    .ach-toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html, body { height: 100%; }
    body{
      margin:0;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(110,231,255,.10), transparent 60%),
        radial-gradient(800px 600px at 80% 0%, rgba(255,209,102,.08), transparent 60%),
        radial-gradient(800px 600px at 80% 100%, rgba(113,247,183,.08), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family:var(--sans);
      line-height:1.55;
      font-size: 16px;
    }
    header{
      padding:16px 16px 8px;
      max-width:1100px;
      margin:0 auto;
    }
    header .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    h1{
      font-size:20px;
      margin:0 0 4px;
      letter-spacing:.1px;
    }
    .subtitle{
      color:var(--muted);
      margin:0;
      font-size:14px;
    }
    /* ‚îÄ‚îÄ Profil-Karten oben ‚îÄ‚îÄ */
    .pillbar{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
      width:100%;
      margin-top:10px;
    }
    .pill{
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:2px;
      user-select:none;
    }
    .pill b{color:var(--text); font-weight:700; font-size:14px;}
    .pill .pill-label { font-size:11px; text-transform:uppercase; letter-spacing:.5px; }
    main{
      max-width:1100px;
      margin:0 auto;
      padding:8px 16px 28px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:14px;
    }
    /* Auf Tablets & Handys: einspaltig */
    @media (max-width: 768px){
      main{ grid-template-columns:1fr; }
      .pillbar{ grid-template-columns: repeat(2, 1fr); }
      h1{ font-size:18px; }
    }
    @media (max-width: 480px){
      .pillbar{ grid-template-columns: 1fr 1fr; }
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 16px 10px;
      border-bottom:1px solid var(--border);
      background:rgba(0,0,0,.16);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .card .hd h2{
      font-size:13px;
      margin:0;
      letter-spacing:.3px;
      text-transform:uppercase;
      color:var(--muted);
    }
    .card .bd{
      padding:14px 16px 18px;
    }
    .stats{
      display:grid;
      gap:9px;
    }
    .stat{
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(0,0,0,.14);
    }
    .stat .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:14px;
      color:var(--muted);
      margin-bottom:7px;
    }
    .stat .row .val { color: var(--text); font-weight: 600; }
    .bar{
      height:12px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:50%;
      background:linear-gradient(90deg, rgba(110,231,255,.95), rgba(113,247,183,.95));
      border-radius:999px;
      transition:width .3s ease;
    }
    .bar.danger > div{
      background:linear-gradient(90deg, rgba(255,107,107,.95), rgba(255,209,102,.95));
    }
    .meta{
      display:grid;
      gap:7px;
      font-size:14px;
      color:var(--muted);
    }
    .meta .kv{
      display:flex;
      justify-content:space-between;
      gap:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.10);
      padding:10px 12px;
      border-radius:14px;
      align-items:center;
    }
    .kv span:last-child{color:var(--text); font-weight:600}
    .scene-title{
      font-size:20px;
      font-weight:700;
      margin:0 0 8px;
    }
    .scene-text{
      color:var(--text);
      margin:0 0 14px;
      font-size:15px;
      line-height:1.6;
      white-space:pre-wrap;
    }
    .hint{
      color:var(--muted);
      font-size:14px;
      margin:12px 0 0;
      padding:12px 14px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.20);
      background:rgba(0,0,0,.10);
      white-space:pre-wrap;
      line-height:1.55;
    }
    .hint::before { content:"üí° "; }
    /* ‚îÄ‚îÄ Auswahlbuttons ‚Äì gro√ü & touch-freundlich ‚îÄ‚îÄ */
    .choices{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
      margin-top:14px;
    }
    /* Bei mehr als 3 Optionen oder schmalen Bildschirmen: 1 Spalte */
    .choices.single-col {
      grid-template-columns: 1fr;
    }
    @media (max-width: 600px){
      .choices { grid-template-columns: 1fr; }
    }
    /* "Weiter" und einzelne Buttons sollen volle Breite haben */
    .choices .btn-full {
      grid-column: 1 / -1;
    }
    .btn{
      border:2px solid var(--border);
      background:rgba(255,255,255,.07);
      color:var(--text);
      border-radius:16px;
      padding:16px 14px;
      font-size:15px;
      font-family: var(--sans);
      text-align:left;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, transform .08s ease;
      min-height: 60px;
      -webkit-user-select: none;
      user-select: none;
      display: block;
      width: 100%;
      line-height: 1.5;
    }
    .btn:hover, .btn:focus { 
      background:rgba(255,255,255,.12); 
      border-color:rgba(110,231,255,.4);
      outline: none;
    }
    .btn:active{ transform: scale(0.98); background:rgba(255,255,255,.15); }
    .btn[disabled]{
      opacity:.45;
      cursor:not-allowed;
      background:rgba(0,0,0,.15);
      border-color: rgba(255,255,255,.06);
    }
    .btn .tag{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin-top:6px;
      font-style: italic;
    }
    .btn .lock{
      color:var(--warn);
      font-size:13px;
      margin-top:6px;
      display:block;
    }
    /* ‚îÄ‚îÄ Log ‚îÄ‚îÄ */
    .log{
      font-size:13px;
      color:var(--muted);
      display:grid;
      gap:7px;
      margin-top: 12px;
    }
    .log-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .4px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .log .entry{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:rgba(0,0,0,.12);
      font-size:13px;
    }
    .log .entry b{color:var(--text); display:block; margin-bottom:2px;}
    /* ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ */
    .toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .smallbtn{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-size:14px;
      font-family: var(--sans);
      min-height: 44px;
      -webkit-user-select: none;
    }
    .smallbtn:hover{background:rgba(255,255,255,.11)}
    .smallbtn.danger{border-color:rgba(255,107,107,.4); color: var(--danger);}
    .smallbtn.ok{border-color:rgba(113,247,183,.4); color: var(--ok);}
    .smallbtn:active{transform:scale(0.97)}
    /* ‚îÄ‚îÄ Outcome-Box ‚îÄ‚îÄ */
    .outcome-box {
      margin-top: 14px;
      padding: 14px 16px;
      border-radius: 16px;
      border: 2px solid;
      font-size: 15px;
      font-weight: 600;
    }
    .outcome-box.ok { border-color: var(--ok); background: rgba(113,247,183,.08); color: var(--ok); }
    .outcome-box.warn { border-color: var(--warn); background: rgba(255,209,102,.08); color: var(--warn); }
    .outcome-box.danger { border-color: var(--danger); background: rgba(255,107,107,.08); color: var(--danger); }
    .footer-note{
      max-width:1100px;
      margin:0 auto;
      padding:0 16px 20px;
      color:var(--muted);
      font-size:13px;
    }
    /* ‚îÄ‚îÄ Gymnasium-Wahrscheinlichkeit ‚îÄ‚îÄ */
    .gymchance-box {
      background: rgba(255,209,102,.07);
      border: 1px solid rgba(255,209,102,.25);
      border-radius: 14px;
      padding: 12px 14px;
      margin: 10px 0 14px;
      font-size: 14px;
      color: var(--warn);
    }
    .gymchance-box .chance-title { font-weight:700; margin-bottom:4px; }
    .gymchance-bar { height: 14px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; margin-top:8px;}
    .gymchance-bar > div { height:100%; border-radius:999px; background: linear-gradient(90deg, #ffd166, #f08c00); transition: width .4s ease;}
    /* ‚îÄ‚îÄ Notenschnitt ‚îÄ‚îÄ */
    .grade-box {
      background: rgba(110,231,255,.07);
      border: 1px solid rgba(110,231,255,.25);
      border-radius: 14px;
      padding: 12px 14px;
      margin-top: 10px;
      font-size: 14px;
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .grade-box .grade-label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .5px; }
    .grade-box .grade-val { font-size: 22px; font-weight: 800; }
    .grade-box .grade-desc { font-size: 13px; color: var(--muted); }
    /* ‚îÄ‚îÄ Zufallsereignis-Overlay ‚îÄ‚îÄ */
    .event-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.65);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 20px;
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
    }
    .event-card {
      background: linear-gradient(180deg, #1a2340, #0f1630);
      border: 2px solid rgba(110,231,255,.3);
      border-radius: 22px;
      padding: 26px 24px;
      max-width: 440px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,.6);
      animation: popIn .25s cubic-bezier(.34,1.56,.64,1);
    }
    @keyframes popIn {
      from { transform: scale(.85); opacity:0; }
      to { transform: scale(1); opacity:1; }
    }
    .event-card .event-icon { font-size: 40px; margin-bottom: 10px; }
    .event-card .event-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--accent); }
    .event-card .event-text { font-size: 14px; color: var(--muted); line-height: 1.6; margin-bottom: 16px; }
    .event-card .event-effects { 
      display: grid; gap: 6px; margin-bottom: 18px;
    }
    .event-card .effect-row {
      font-size: 13px; 
      padding: 7px 11px;
      border-radius: 10px;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--border);
    }
    .event-card .effect-row.pos { color: var(--ok); border-color: rgba(113,247,183,.2); }
    .event-card .effect-row.neg { color: var(--danger); border-color: rgba(255,107,107,.2); }
    .event-card .effect-row.neu { color: var(--warn); border-color: rgba(255,209,102,.2); }
    .event-btn {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      background: linear-gradient(90deg, rgba(110,231,255,.2), rgba(113,247,183,.2));
      color: var(--text);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      font-family: var(--sans);
      border: 1px solid rgba(110,231,255,.3);
      min-height: 48px;
      -webkit-tap-highlight-color: transparent;
    }
    .event-btn:active { transform: scale(0.98); }

    /* ‚îÄ‚îÄ Anleitung / Tutorial Modal ‚îÄ‚îÄ */
    .help-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.75);
      display: flex; align-items: center; justify-content: center;
      z-index: 999; padding: 16px;
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
    }
    .help-card {
      background: linear-gradient(160deg, #1a2545, #0d1428);
      border: 1px solid rgba(110,231,255,.3);
      border-radius: 22px; padding: 24px 22px;
      max-width: 520px; width: 100%; max-height: 88vh; overflow-y: auto;
      box-shadow: 0 24px 60px rgba(0,0,0,.6);
      animation: popIn .3s cubic-bezier(.34,1.56,.64,1);
    }
    .help-card h3 { margin: 0 0 4px; font-size: 19px; color: var(--accent); }
    .help-card .help-sub { font-size: 13px; color: var(--muted); margin-bottom: 18px; }
    .help-section { margin-bottom: 18px; }
    .help-section h4 {
      font-size: 13px; text-transform: uppercase; letter-spacing: .5px;
      color: var(--muted); margin: 0 0 8px; border-bottom: 1px solid var(--border); padding-bottom: 5px;
    }
    .help-section p { font-size: 14px; line-height: 1.65; color: var(--text); margin: 0 0 8px; }
    .help-stat-row {
      display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;
    }
    .help-stat {
      background: rgba(255,255,255,.06); border: 1px solid var(--border);
      border-radius: 10px; padding: 8px 10px; font-size: 12px; flex: 1; min-width: 100px;
    }
    .help-stat .hs-icon { font-size: 18px; display: block; margin-bottom: 3px; }
    .help-stat .hs-name { font-weight: 700; color: var(--text); display: block; }
    .help-stat .hs-desc { color: var(--muted); font-size: 11px; }
    .help-close {
      width: 100%; padding: 13px; border-radius: 12px; cursor: pointer;
      font-family: var(--sans); font-size: 15px; font-weight: 600; margin-top: 4px;
      background: rgba(110,231,255,.15); border: 1px solid rgba(110,231,255,.3); color: var(--accent);
      min-height: 44px;
    }
    .help-close:hover { background: rgba(110,231,255,.22); }

    /* ‚îÄ‚îÄ Ergebniskarte verbessert ‚îÄ‚îÄ */
    .qr-card .qr-sub { font-size: 13px; color: var(--muted); margin-bottom: 14px; line-height: 1.5; }
    .qr-summary { font-size: 13px; line-height: 1.8; }

    /* ‚îÄ‚îÄ Fortschrittsbalken ‚îÄ‚îÄ */
    .progress-bar-wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 6px 16px 10px;
    }
    .progress-track {
      position: relative;
      height: 8px;
      background: rgba(255,255,255,.08);
      border-radius: 999px;
      overflow: visible;
      margin-bottom: 4px;
    }
    .progress-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #6ee7ff, #71f7b7);
      transition: width .5s cubic-bezier(.4,0,.2,1);
      position: relative;
    }
    .progress-dot {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--bg);
      border: 2px solid rgba(255,255,255,.25);
      font-size: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: default;
      transition: border-color .3s, background .3s;
      z-index: 2;
    }
    .progress-dot.done { border-color: #71f7b7; background: rgba(113,247,183,.2); }
    .progress-dot.active { border-color: #6ee7ff; background: rgba(110,231,255,.25); width:18px; height:18px; box-shadow: 0 0 0 3px rgba(110,231,255,.2); }
    .progress-labels {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: var(--muted);
      padding: 0 2px;
    }

    /* ‚îÄ‚îÄ Profilkarte Intro-Overlay ‚îÄ‚îÄ */
    .profile-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.70);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 998;
      padding: 20px;
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
    }
    .profile-card {
      background: linear-gradient(160deg, #1a2a50, #0d1628);
      border: 2px solid rgba(110,231,255,.35);
      border-radius: 24px;
      padding: 28px 26px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 24px 70px rgba(0,0,0,.6);
      animation: popIn .3s cubic-bezier(.34,1.56,.64,1);
    }
    .profile-card .pc-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .8px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .profile-card .pc-headline {
      font-size: 22px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 18px;
    }
    .profile-card .pc-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 20px;
    }
    .profile-card .pc-item {
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
    }
    .profile-card .pc-item .pc-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: .4px;
      color: var(--muted);
      margin-bottom: 3px;
    }
    .profile-card .pc-item .pc-val {
      font-weight: 700;
      color: var(--text);
      font-size: 14px;
    }
    .profile-card .pc-engagement {
      margin-bottom: 18px;
      padding: 12px 14px;
      border-radius: 14px;
      font-size: 14px;
      border: 1px solid;
    }
    .profile-card .pc-engagement.hoch    { border-color: rgba(113,247,183,.4); background: rgba(113,247,183,.06); color: var(--ok); }
    .profile-card .pc-engagement.mittel  { border-color: rgba(110,231,255,.3); background: rgba(110,231,255,.05); color: var(--accent); }
    .profile-card .pc-engagement.niedrig { border-color: rgba(255,209,102,.3); background: rgba(255,209,102,.05); color: var(--warn); }
    .profile-card .pc-engagement.vernachlaessigt { border-color: rgba(255,107,107,.3); background: rgba(255,107,107,.05); color: var(--danger); }
    .profile-card .pc-start-btn {
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      border: none;
      background: linear-gradient(90deg, rgba(110,231,255,.25), rgba(113,247,183,.25));
      border: 1px solid rgba(110,231,255,.4);
      color: var(--text);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      font-family: var(--sans);
      min-height: 52px;
    }
    .profile-card .pc-start-btn:active { transform: scale(.98); }
    .profile-card .pc-reroll {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-size: 14px;
      cursor: pointer;
      font-family: var(--sans);
    }
    .profile-card .pc-reroll:hover { background: rgba(255,255,255,.05); color: var(--text); }

    /* ‚îÄ‚îÄ Was-w√§re-wenn Modal ‚îÄ‚îÄ */
    .wwiw-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.70);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 997;
      padding: 20px;
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
    }
    .wwiw-card {
      background: linear-gradient(160deg, #1a2a50, #0d1628);
      border: 2px solid rgba(255,209,102,.35);
      border-radius: 24px;
      padding: 26px 24px;
      max-width: 520px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 24px 70px rgba(0,0,0,.6);
      animation: popIn .3s cubic-bezier(.34,1.56,.64,1);
    }
    .wwiw-card h3 { font-size: 18px; font-weight: 800; color: var(--warn); margin: 0 0 6px; }
    .wwiw-card .wwiw-sub { font-size: 13px; color: var(--muted); margin-bottom: 18px; }
    .wwiw-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-size: 14px;
    }
    .wwiw-row label { color: var(--muted); min-width: 130px; font-size: 13px; }
    .wwiw-row select {
      flex: 1;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      padding: 8px 10px;
      font-size: 13px;
      font-family: var(--sans);
    }
    .wwiw-result {
      margin: 16px 0;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.2);
      font-size: 14px;
    }
    .wwiw-result .wwiw-score-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--muted);
    }
    .wwiw-result .wwiw-score-row b { color: var(--text); }
    .wwiw-btn {
      width: 100%;
      padding: 13px;
      border-radius: 14px;
      border: none;
      background: linear-gradient(90deg, rgba(255,209,102,.2), rgba(255,180,50,.2));
      border: 1px solid rgba(255,209,102,.4);
      color: var(--text);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      font-family: var(--sans);
      margin-bottom: 10px;
    }
    .wwiw-close {
      width: 100%;
      padding: 11px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-size: 14px;
      cursor: pointer;
      font-family: var(--sans);
    }

    /* ‚îÄ‚îÄ QR-Code Overlay ‚îÄ‚îÄ */
    .qr-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.72);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 20px;
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
    }
    .qr-card {
      background: linear-gradient(160deg, #1a2a50, #0d1628);
      border: 2px solid rgba(113,247,183,.35);
      border-radius: 24px;
      padding: 28px 24px;
      max-width: 380px;
      width: 100%;
      text-align: center;
      box-shadow: 0 24px 70px rgba(0,0,0,.6);
      animation: popIn .3s cubic-bezier(.34,1.56,.64,1);
    }
    .qr-card h3 { font-size: 18px; font-weight: 800; color: var(--ok); margin: 0 0 6px; }
    .qr-card .qr-sub { font-size: 13px; color: var(--muted); margin-bottom: 18px; }
    .qr-card #qrCanvas {
      border-radius: 14px;
      margin: 0 auto 16px;
      display: block;
      background: white;
      padding: 12px;
    }
    .qr-card .qr-summary {
      font-size: 13px;
      color: var(--muted);
      background: rgba(0,0,0,.2);
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 16px;
      text-align: left;
      line-height: 1.7;
    }
    .qr-close {
      width: 100%;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-size: 14px;
      cursor: pointer;
      font-family: var(--sans);
    }
  </style>
</head>
<body>
  <header>
    <div class="top">
      <div>
        <h1>üéÆ Dein Weg ‚Äì Bildung & Chancen</h1>
        <p class="subtitle">Ein Spiel √ºber Chancengleichheit in Deutschland ‚Äì Alter 6 bis 18 Jahre</p>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button class="smallbtn" id="btnTheme">üåô Dark</button>
        <button class="smallbtn" id="btnHelp">‚ùì Anleitung</button>
        <button class="smallbtn" id="btnWhatIf" style="display:none">üîÆ Was w√§re wenn?</button>
        <button class="smallbtn" id="btnQR" style="display:none">üì≤ Ergebnis teilen</button>
        <button class="smallbtn ok" id="btnNew">üîÑ Neu starten</button>
        <button class="smallbtn danger" id="btnReset">‚Ü∫ Zur√ºcksetzen</button>
      </div>
    </div>
    <div class="pillbar" id="pillbar"></div>
  </header>

  <!-- Fortschrittsbalken -->
  <div class="progress-bar-wrap">
    <div class="progress-track" id="progressTrack">
      <div class="progress-fill" id="progressFill" style="width:0%"></div>
    </div>
    <div class="progress-labels">
      <span>6 J.</span>
      <span>Grundschule</span>
      <span>Sek I</span>
      <span>Oberstufe</span>
      <span>18 J.</span>
    </div>
  </div>

  <main>
    <section class="card" aria-label="Profil & Ressourcen">
      <div class="hd">
        <h2>Dein Profil</h2>
        <span style="font-size:12px; color:var(--muted);">Alter: <b id="ageLabel" style="color:var(--text)">6</b> Jahre</span>
      </div>
      <div class="bd">
        <div class="meta" id="meta"></div>
        <div style="height:10px"></div>
        <div class="grade-box" id="gradeBox">
          <div>
            <div class="grade-label">üìù Notenschnitt</div>
            <div class="grade-val" id="gradeVal">‚Äì</div>
            <div class="grade-desc" id="gradeDesc">Noch keine Noten</div>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="stats" id="stats"></div>
        <div style="height:10px"></div>
        <div class="log-title">üìã Ereignisse</div>
        <div class="log" id="log"></div>
      </div>
    </section>

    <section class="card" aria-label="Szene & Entscheidungen">
      <div class="hd">
        <h2>Aktuelle Situation</h2>
        <div class="pill" style="border-radius:10px; padding:6px 10px;">
          <span class="pill-label">Phase</span>
          <b id="phaseLabel">‚Äì</b>
        </div>
      </div>
      <div class="bd">
        <h3 class="scene-title" id="sceneTitle"></h3>
        <p class="scene-text" id="sceneText"></p>
        <div id="gymchanceContainer"></div>
        <div class="choices" id="choices"></div>
        <p class="hint" id="reflection" style="display:none"></p>
      </div>
    </section>
  </main>

  <div class="footer-note">
    üìò Dieses Spiel zeigt, wie unterschiedliche Startbedingungen den Bildungsweg beeinflussen. Es ist kein Urteil √ºber Einzelpersonen ‚Äì aber ein Blick auf das System.
  </div>

<script>
/**
 * Prototyp-Logik (ohne Libraries).
 * Ziel: strukturelle Ungleichheiten erfahrbar machen, ohne platt zu moralisieren.
 */

// ---------- Utilities ----------
const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
const rnd = (arr) => arr[Math.floor(Math.random() * arr.length)];
const nowISO = () => new Date().toISOString();

function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

// ---------- Game State ----------
const DEFAULT_STATE = () => ({
  id: crypto?.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2),
  createdAt: nowISO(),
  age: 6,
  phase: "Grundschule",
  profile: {
    region: null,
    wohnlage: null,
    family: null,
    income: null,
    languageHome: null,
    elternBildung: null,
  },
  stats: {
    geld: 50,          // 0..100 (Proxy f√ºr finanzielle Mittel)
    bildung: 40,       // 0..100
    stress: 20,        // 0..100 (hoch = schlecht)
    sprache: 50,       // 0..100 (Deutschkompetenz)
    sozial: 40         // 0..100 (Netzwerke / Zugeh√∂rigkeit)
  },
  flags: {
    hatLaptop: false,
    kenntLehrkraft: false,
    hatFoerderung: false,
    warAufKlassenfahrt: null,
    uebungDeutschAG: false,
    elternAkademiker: false,
    gymnasiumErreicht: false,
    noteGrundschule: null,
    noteSek1: null,
    zufallsereignisGesehen: false,
    elternEngagement: "mittel",  // "hoch" | "mittel" | "niedrig" | "vernachlaessigt"
  },
  log: [],
  currentScene: "intro"
});

let state = null;

// ---------- Startbedingungen (Deutschland) ----------
const START_PROFILES = {
  region: ["Gro√üstadt", "Mittelstadt", "L√§ndlicher Raum"],
  wohnlage: ["gute Lage", "durchschnittliche Lage", "benachteiligte Lage"],
  family: ["2 Elternteile", "alleinerziehend", "Patchwork"],
  income: ["hoch", "mittel", "niedrig"],
  languageHome: ["Deutsch", "Deutsch & andere Sprache", "vorwiegend andere Sprache"],
  elternBildung: ["Akademiker (Uni/FH)", "Berufsausbildung", "ohne Abschluss"]
};

function rollStartState(){
  const s = DEFAULT_STATE();
  s.profile.region = rnd(START_PROFILES.region);
  s.profile.family = rnd(START_PROFILES.family);
  s.profile.income = rnd(START_PROFILES.income);
  s.profile.languageHome = rnd(START_PROFILES.languageHome);
  s.profile.elternBildung = rnd(START_PROFILES.elternBildung);

  // Wohnlage h√§ngt stark vom Einkommen ab (recherchiert: Segregation in DE)
  // Hohe Einkommen ‚Üí fast immer gute Lage; niedrige ‚Üí h√§ufig benachteiligte Lage
  {
    const r = Math.random();
    if (s.profile.income === "hoch") {
      // 60% gute Lage, 38% durchschnittlich, 2% benachteiligt
      s.profile.wohnlage = r < 0.60 ? "gute Lage" : r < 0.98 ? "durchschnittliche Lage" : "benachteiligte Lage";
    } else if (s.profile.income === "mittel") {
      // 20% gute Lage, 60% durchschnittlich, 20% benachteiligt
      s.profile.wohnlage = r < 0.20 ? "gute Lage" : r < 0.80 ? "durchschnittliche Lage" : "benachteiligte Lage";
    } else {
      // 5% gute Lage, 35% durchschnittlich, 60% benachteiligt
      s.profile.wohnlage = r < 0.05 ? "gute Lage" : r < 0.40 ? "durchschnittliche Lage" : "benachteiligte Lage";
    }
  }

  // Einkommen ‚Üí finanzielle Mittel
  if (s.profile.income === "hoch") s.stats.geld = 80;
  if (s.profile.income === "mittel") s.stats.geld = 50;
  if (s.profile.income === "niedrig") s.stats.geld = 22;

  // Sprache zu Hause ‚Üí Deutschkenntnisse
  if (s.profile.languageHome === "Deutsch") s.stats.sprache = 65;
  if (s.profile.languageHome === "Deutsch & andere Sprache") s.stats.sprache = 55;
  if (s.profile.languageHome === "vorwiegend andere Sprache") s.stats.sprache = 38;

  // Wohnlage ‚Üí Sozial & Stress
  if (s.profile.wohnlage === "gute Lage") { s.stats.sozial += 8; s.stats.stress -= 5; }
  if (s.profile.wohnlage === "benachteiligte Lage") { s.stats.sozial -= 7; s.stats.stress += 7; }

  // Elternbildung: beeinflusst Bildungskapital stark
  if (s.profile.elternBildung === "Akademiker (Uni/FH)") {
    s.stats.bildung += 12; s.stats.sozial += 10;
    s.flags.elternAkademiker = true;
  }
  if (s.profile.elternBildung === "Berufsausbildung") {
    s.stats.bildung += 4; s.stats.sozial += 3;
    s.flags.elternAkademiker = false;
  }
  if (s.profile.elternBildung === "ohne Abschluss") {
    s.stats.bildung -= 5; s.stats.stress += 5;
    s.flags.elternAkademiker = false;
  }

  // Bildungs- und Teilhabepaket (BuT): NUR f√ºr Haushalte mit niedrigem Einkommen
  // (SGB II / Wohngeld / Kinderzuschlag-Bezug)
  // Zug√§nglichkeit variiert nach Region (B√ºrokratie, Bekanntheit)
  if (s.profile.income === "niedrig") {
    const r = Math.random();
    if (s.profile.region === "Gro√üstadt") s.flags.hatFoerderung = r < 0.55;      // gut vernetzt, aber auch mehr B√ºrokratie
    else if (s.profile.region === "Mittelstadt") s.flags.hatFoerderung = r < 0.42;
    else s.flags.hatFoerderung = r < 0.28; // L√§ndlicher Raum: F√∂rderung kaum bekannt/erreichbar
  } else {
    s.flags.hatFoerderung = false; // Mittel und Hoch: kein Anspruch auf BuT
  }

  // Eltern-Engagement: unabh√§ngig von Bildung/Geld, aber beeinflusst davon
  {
    const r = Math.random();
    if (s.profile.elternBildung === "Akademiker (Uni/FH)") {
      if (r < 0.30) s.flags.elternEngagement = "hoch";
      else if (r < 0.70) s.flags.elternEngagement = "mittel";
      else if (r < 0.95) s.flags.elternEngagement = "niedrig";
      else s.flags.elternEngagement = "vernachlaessigt";
    } else if (s.profile.elternBildung === "Berufsausbildung") {
      if (r < 0.25) s.flags.elternEngagement = "hoch";
      else if (r < 0.70) s.flags.elternEngagement = "mittel";
      else if (r < 0.92) s.flags.elternEngagement = "niedrig";
      else s.flags.elternEngagement = "vernachlaessigt";
    } else {
      if (r < 0.12) s.flags.elternEngagement = "hoch";
      else if (r < 0.47) s.flags.elternEngagement = "mittel";
      else if (r < 0.79) s.flags.elternEngagement = "niedrig";
      else s.flags.elternEngagement = "vernachlaessigt";
    }
    // Alleinerziehend: erh√∂ht Vernachl√§ssigungs-Risiko leicht (√úberlastung)
    if (s.profile.family === "alleinerziehend" && s.flags.elternEngagement === "mittel" && Math.random() < 0.25) {
      s.flags.elternEngagement = "niedrig";
    }
  }

  normalizeStats(s);
  pushLog(s, "Spielstart", "Deine Ausgangslage wurde zuf√§llig bestimmt ‚Äì genau wie im echten Leben.");
  return s;
}

// ---------- Notenschnitt berechnen ----------
function computeGrade(s) {
  // Realistisch: Deutscher Durchschnitt liegt bei ca. 2.5‚Äì3.0
  // Bildung 40 (Start) ‚Üí Note ~2.8 (realistischer Mittelpunkt)
  // Bildung 70+ ‚Üí Note ~1.8 (sehr gut, Gymnasium-typisch)
  // Bildung 25‚Äì ‚Üí Note ~3.8 (Hauptschule-typisch)
  // Formel: Note = 4.5 - (bildung / 35) + stress*0.015 - (sprache-50)*0.01
  const bildungsFaktor = s.stats.bildung / 35;          // 40‚Üí1.14, 70‚Üí2.0, 25‚Üí0.71
  const stressMalus    = s.stats.stress * 0.015;         // stress 50 ‚Üí +0.75
  const sprachBonus    = (s.stats.sprache - 50) * 0.01; // sprache 65 ‚Üí +0.15
  let raw = 4.5 - bildungsFaktor + stressMalus - sprachBonus;
  raw = Math.max(1.0, Math.min(5.5, raw));
  return Math.round(raw * 10) / 10;
}

function gradeDescription(g) {
  if (g <= 1.5) return "Sehr gut üåü";
  if (g <= 2.5) return "Gut üëç";
  if (g <= 3.5) return "Befriedigend üòä";
  if (g <= 4.5) return "Ausreichend üòê";
  if (g <= 5.5) return "Mangelhaft üòü";
  return "Ungen√ºgend üòî";
}

// ---------- Zufallsereignisse ----------
const RANDOM_EVENTS = [
  {
    id: "krankheit",
    icon: "ü§í",
    title: "Du wirst krank!",
    text: "Du fehlst zwei Wochen in der Schule. Den Stoff musst du alleine aufholen ‚Äì manche haben dabei Hilfe, andere nicht.",
    effects: (s) => { s.stats.bildung -= 5; s.stats.stress += 8; },
    effectLabels: [
      { text: "üìö Bildung ‚Äì5", kind: "neg" },
      { text: "üò∞ Stress +8", kind: "neg" }
    ]
  },
  {
    id: "umzug",
    icon: "üì¶",
    title: "Ihr zieht um!",
    text: "Deine Familie muss in einen anderen Stadtteil ziehen. Neue Schule, neue Mitsch√ºler ‚Äì das ist aufw√§ndig und anstrengend.",
    effects: (s) => { s.stats.sozial -= 8; s.stats.stress += 6; s.stats.bildung -= 3; },
    effectLabels: [
      { text: "ü§ù Sozial ‚Äì8", kind: "neg" },
      { text: "üò∞ Stress +6", kind: "neg" },
      { text: "üìö Bildung ‚Äì3", kind: "neg" }
    ]
  },
  {
    id: "foerderprogramm",
    icon: "üéâ",
    title: "Gl√ºck: F√∂rderprogramm!",
    text: "Deine Schule nimmt an einem besonderen F√∂rderprogramm teil. Du bekommst extra Unterst√ºtzung ‚Äì kostenlos!",
    effects: (s) => { s.stats.bildung += 8; s.flags.hatFoerderung = true; },
    effectLabels: [
      { text: "üìö Bildung +8", kind: "pos" },
      { text: "‚úÖ F√∂rderung verf√ºgbar", kind: "pos" }
    ]
  },
  {
    id: "schulstreik",
    icon: "‚úä",
    title: "Schulstreik ‚Äì du machst mit!",
    text: "In deiner Klasse gibt es Streit um bessere Ausstattung. Du engagierst dich. Das st√§rkt dich ‚Äì aber kostet auch Zeit.",
    effects: (s) => { s.stats.sozial += 6; s.stats.bildung -= 2; s.stats.stress += 3; },
    effectLabels: [
      { text: "ü§ù Sozial +6", kind: "pos" },
      { text: "üìö Bildung ‚Äì2", kind: "neg" },
      { text: "üò∞ Stress +3", kind: "neg" }
    ]
  },
  {
    id: "internetausfall",
    icon: "üì°",
    title: "Kein Internet zuhause!",
    text: "Euer Internetvertrag wurde gek√ºndigt. F√ºr mehrere Wochen habt ihr kein WLAN ‚Äì Hausaufgaben und Online-Unterricht sind kaum m√∂glich.",
    effects: (s) => { s.stats.bildung -= 6; s.stats.stress += 5; },
    effectLabels: [
      { text: "üìö Bildung ‚Äì6", kind: "neg" },
      { text: "üò∞ Stress +5", kind: "neg" }
    ]
  },
  {
    id: "stipendium",
    icon: "üèÜ",
    title: "Du gewinnst ein kleines Stipendium!",
    text: "Eine Stiftung unterst√ºtzt Kinder mit besonderen Leistungen. Du bekommst einen kleinen Betrag f√ºr Lernmaterialien.",
    effects: (s) => { s.stats.geld += 12; s.stats.bildung += 4; },
    effectLabels: [
      { text: "üí∞ Geld +12", kind: "pos" },
      { text: "üìö Bildung +4", kind: "pos" }
    ]
  },
  {
    id: "elterntrennung",
    icon: "üíî",
    title: "Schwierige Zeit zuhause",
    text: "Bei dir zuhause ist gerade viel los ‚Äì die Eltern trennen sich. Das ist emotional anstrengend und lenkt vom Lernen ab.",
    effects: (s) => { s.stats.stress += 10; s.stats.sozial -= 4; s.stats.bildung -= 3; },
    effectLabels: [
      { text: "üò∞ Stress +10", kind: "neg" },
      { text: "ü§ù Sozial ‚Äì4", kind: "neg" },
      { text: "üìö Bildung ‚Äì3", kind: "neg" }
    ]
  },
  {
    id: "buechereiausweis",
    icon: "üìö",
    title: "Du entdeckst die B√ºcherei!",
    text: "Deine Lehrerin zeigt euch die Stadtb√ºcherei. Du holst dir einen Ausweis und leihst regelm√§√üig B√ºcher aus ‚Äì kostenlos!",
    effects: (s) => { s.stats.bildung += 6; s.stats.stress -= 3; },
    effectLabels: [
      { text: "üìö Bildung +6", kind: "pos" },
      { text: "üò∞ Stress ‚Äì3", kind: "pos" }
    ]
  }
];

let pendingEvent = null;

function rollRandomEvent(s) {
  // ~15% Chance auf ein Zufallsereignis
  if (Math.random() > 0.15) return null;
  const pool = RANDOM_EVENTS.filter(e => !s.log.some(l => l.title === e.title));
  if (!pool.length) return null;
  return pool[Math.floor(Math.random() * pool.length)];
}

// ---------- Scenes ----------
const SCENES = {
  intro: {
    phase: "Grundschule",
    title: "üè´ Erster Schultag ‚Äì 1. Klasse (6 Jahre)",
    text: "Du kommst in die 1. Klasse. Alle sind aufgeregt! Aber nicht alle Kinder starten mit den gleichen M√∂glichkeiten.\n\nDein Zuhause, deine Familie und dein Wohnort beeinflussen deinen Schulweg ‚Äì schon von Anfang an.",
    reflection: "Merke: Gerechtigkeit bedeutet, dass alle echte Chancen bekommen ‚Äì auch wenn das unterschiedliche Unterst√ºtzung bedeutet.",
    choices: [
      { label: "üéí Los geht's ‚Äì Grundschulalltag beginnt!", next: "klassenfahrt" }
    ]
  },

  klassenfahrt: {
    phase: "Grundschule",
    title: "üöå Klassenfahrt (250 Euro)",
    text: "Die Klasse plant eine Klassenfahrt! Drei Tage im Schullandheim ‚Äì alle freuen sich. Aber die Fahrt kostet 250 Euro.\n\nDeine Eltern m√ºssen entscheiden, was m√∂glich ist.",
    reflection: "Frage: Ist es fair, dass manche Kinder nicht mitfahren k√∂nnen, weil das Geld fehlt?",
    choices: [
      {
        label: "‚úÖ Eltern zahlen ‚Äì du f√§hrst mit",
        next: "hausaufgaben",
        requires: (s) => s.profile.income === "hoch" || s.stats.geld >= 45,
        lockReason: "‚õî Nicht genug Geld f√ºr die Fahrt.",
        effects: (s) => {
          // Hohe Einkommen: kein sp√ºrbarer Unterschied im Budget
          const kostet = s.profile.income === "hoch" ? 5 : 30;
          s.stats.geld -= kostet; s.stats.sozial += 10; s.stats.stress -= 3;
          s.flags.warAufKlassenfahrt = true;
          pushLog(s, "üöå Klassenfahrt", "Du f√§hrst mit ‚Äì tolle Erfahrungen, neue Freundschaften.");
        },
        note: "F√ºr Familien mit hohem Einkommen ist das eine Kleinigkeit. F√ºr andere kann es die ganze Haushaltskasse sprengen."
      },
      {
        label: "üìÑ Hilfe beantragen (Bildung & Teilhabe)",
        next: "hausaufgaben",
        requires: (s) => s.profile.income === "niedrig",
        lockReason: "‚õî Das Bildungs- und Teilhabepaket (BuT) ist nur f√ºr Haushalte mit geringem Einkommen (SGB II etc.) zug√§nglich.",
        effects: (s) => {
          if (s.flags.hatFoerderung) {
            s.flags.warAufKlassenfahrt = true;
            s.stats.sozial += 8; s.stats.stress += 3;
            pushLog(s, "Klassenfahrt", "Der Antrag wurde bewilligt! Du f√§hrst mit ‚Äì aber der Papierkram war anstrengend.");
          } else {
            s.flags.warAufKlassenfahrt = false;
            s.stats.stress += 6; s.stats.sozial -= 3;
            pushLog(s, "Klassenfahrt", "Der Antrag kam zu sp√§t, die Familie wusste nicht wie ‚Äì du f√§hrst nicht mit.");
          }
        },
        note: "Der Staat kann helfen ‚Äì aber Formulare ausf√ºllen ist nicht f√ºr alle einfach. Viele berechtigte Familien nutzen das BuT nicht."
      },
      {
        label: "‚ùå Nicht mitfahren ‚Äì kein Geld",
        next: "hausaufgaben",
        effects: { sozial: -8, stress: +5, flag: ["warAufKlassenfahrt", false] },
        note: "Du bleibst zuhause. Das tut weh ‚Äì und man verpasst Dinge, √ºber die alle reden."
      }
    ]
  },

  hausaufgaben: {
    phase: "Grundschule",
    title: "üìñ Hausaufgaben ‚Äì wer hilft dir?",
    text: "Du sollst f√ºr die Schule √ºben und ein Arbeitsblatt machen. Manche Kinder haben zuhause jemanden, der hilft. Andere nicht.\n\nAuch Ruhe, Platz und Zeit z√§hlen ‚Äì nicht nur Flei√ü.",
    reflection: "Gute Noten h√§ngen also stark vom Zuhause ab ‚Äì nicht nur vom Flei√ü des Kindes!",
    choices: [
      {
        label: "üë®‚Äçüë©‚Äçüëß Eltern helfen regelm√§√üig",
        next: "deutsch_ag",
        requires: (s) => s.flags.elternEngagement === "hoch" &&
          (s.profile.languageHome !== "vorwiegend andere Sprache" || s.stats.sprache >= 55),
        lockReason: "‚õî Deine Eltern haben daf√ºr gerade nicht die Zeit, Energie oder Sprachkenntnisse.",
        effects: { bildung: +10, stress: -3, sozial: +2 },
        note: "Regelm√§√üige Unterst√ºtzung wirkt wie ein Booster f√ºrs Lernen."
      },
      {
        label: "üí∞ Nachhilfe bezahlen",
        next: "deutsch_ag",
        requires: (s) => s.stats.geld >= 35,
        lockReason: "‚õî Nicht genug Geld f√ºr Nachhilfe.",
        effects: { geld: -15, bildung: +12, stress: -2 },
        note: "Wer zahlen kann, kann Schw√§chen schneller ausgleichen ‚Äì ein echter Vorteil."
      },
      {
        label: "ü§î Alleine versuchen",
        next: "deutsch_ag",
        effects: (s) => {
          const success = 0.35 + (s.stats.sprache/200) + (s.stats.bildung/250);
          if (Math.random() < success){
            s.stats.bildung += 7; s.stats.stress += 1;
            pushLog(s, "Hausaufgaben", "Du schaffst es! Aber es war wirklich m√ºhsam.");
          } else {
            s.stats.bildung += 2; s.stats.stress += 6;
            pushLog(s, "Hausaufgaben", "Du kommst nicht weiter. Das ist frustrierend.");
          }
        },
        note: "Manchmal klappt es alleine ‚Äì aber es kostet viel mehr Kraft."
      },
      {
        label: "üòì Aufgaben bleiben liegen",
        next: "deutsch_ag",
        requires: (s) => s.flags.elternEngagement === "vernachlaessigt" || s.flags.elternEngagement === "niedrig",
        lockReason: "‚õî Du hast genug Unterst√ºtzung ‚Äì die Aufgaben k√∂nnen nicht einfach liegen bleiben.",
        effects: { bildung: -4, stress: +8, sozial: -2 },
        note: "Zuhause ist niemand da, der darauf achtet. Das passiert ‚Äì aber die L√ºcken wachsen."
      }
    ]
  },

  deutsch_ag: {
    phase: "Grundschule",
    title: "üó£Ô∏è Deutsch-F√∂rder-AG ‚Äì mitmachen oder nicht?",
    text: "Die Schule bietet nachmittags eine F√∂rder-AG an. Du k√∂nntest dein Deutsch verbessern. Aber: Die AG ist nach dem Unterricht ‚Äì und zuhause warten vielleicht andere Aufgaben.",
    reflection: "F√∂rderangebote sind gut ‚Äì aber nur wenn man auch wirklich hingehen kann!",
    choices: [
      {
        label: "‚úÖ Mitmachen bei der F√∂rder-AG",
        next: "alltag_handy",
        effects: (s) => {
          s.flags.uebungDeutschAG = true;
          s.stats.sprache += 10; s.stats.stress += 2; s.stats.bildung += 4;
          pushLog(s, "F√∂rder-AG", "Du gehst regelm√§√üig hin. Dein Deutsch wird deutlich besser!");
        },
        note: "F√∂rderung hilft ‚Äì wenn man Zeit und M√∂glichkeit hat, sie zu nutzen."
      },
      {
        label: "‚ùå Keine Zeit / andere Pflichten",
        next: "alltag_handy",
        effects: { stress: +2, sozial: +1 },
        note: "Manchmal ist der Alltag einfach zu voll. Das ist keine Faulheit."
      }
    ]
  },

  uebergang: {
    phase: "√úbergang",
    title: "üè´ Welche Schule kommt nach der Grundschule? (10 Jahre)",
    text: "Nach der 4. Klasse wird entschieden: Gymnasium, Realschule oder Hauptschule? Noten z√§hlen ‚Äì aber auch die Eltern, Lehrer-Erwartungen und das Umfeld spielen eine gro√üe Rolle.",
    reflection: "Studien zeigen: Kinder aus Akademiker-Familien werden mit gleichen Noten deutlich h√§ufiger f√ºrs Gymnasium empfohlen!",
    choices: [
      {
        label: "üìö Eltern k√§mpfen aktiv um einen Gymnasialplatz",
        next: "gymnasium_entscheidung",
        requires: (s) => (s.flags.elternEngagement === "hoch" || s.flags.elternEngagement === "mittel") &&
                         (s.stats.sozial >= 35 || s.profile.income !== "niedrig"),
        lockReason: "‚õî Deine Eltern sind entweder nicht engagiert genug oder ihnen fehlen die Zeit, Energie und Erfahrung mit dem Schulsystem.",
        effects: { sozial: +6, stress: +3, bildung: +3 },
        note: "Wer wei√ü, wie man mit Schulen spricht, und sich auch die Zeit nimmt, hat einen echten Vorteil."
      },
      {
        label: "üó£Ô∏è Du gehst selbst zur Lehrerin / zum Lehrer",
        next: "gymnasium_entscheidung",
        requires: (s) => s.stats.sprache >= 48,
        lockReason: "‚õî Sprachliche H√ºrden machen das Gespr√§ch sehr schwierig.",
        effects: { sozial: +4, stress: +2, flag: ["kenntLehrkraft", true] },
        note: "Mut und Kommunikation k√∂nnen viel bewegen ‚Äì aber nicht alle haben diese M√∂glichkeit."
      },
      {
        label: "üòê Ihr wartet ab, was passiert",
        next: "gymnasium_entscheidung",
        effects: { stress: +3, sozial: -2 },
        note: "Passivit√§t ist oft nicht Gleichg√ºltigkeit ‚Äì sondern Ersch√∂pfung, Unsicherheit oder fehlendes Wissen √ºber das System."
      }
    ]
  },

  gymnasium_entscheidung: {
    phase: "√úbergang",
    title: "üéì Gymnasium ‚Äì Klappt es? (10 Jahre)",
    gymChance: true,
    text: "Jetzt zeigt sich, ob es mit dem Gymnasium klappt. In Deutschland spielt der famili√§re Hintergrund eine riesige Rolle:\n\nüìä Laut Studien: Kinder von Akademiker-Eltern kommen mit gleichen Noten dreimal so h√§ufig aufs Gymnasium wie Kinder ohne diesen Hintergrund.",
    reflection: "Das nennt man soziale Ungleichheit: Es ist nicht fair ‚Äì aber es ist die Realit√§t in Deutschland.",
    choices: [
      {
        label: "‚û°Ô∏è Weiter ‚Äì Schulzuweisung annehmen",
        next: "gymnasium_ergebnis",
        effects: (s) => {
          // Gymnasium-Wahrscheinlichkeit berechnen ‚Äì realistischer, niedriger
          let gymChance = 0.15; // Basis sehr niedrig (ohne Kontext kommt man kaum rein)
          if (s.flags.elternAkademiker) gymChance += 0.28;
          if (s.profile.income === "hoch") gymChance += 0.12;
          if (s.profile.income === "mittel") gymChance += 0.05;
          if (s.stats.bildung >= 65) gymChance += 0.14;
          else if (s.stats.bildung >= 50) gymChance += 0.07;
          if (s.flags.kenntLehrkraft) gymChance += 0.08;
          if (s.flags.uebungDeutschAG) gymChance += 0.04;
          if (s.stats.sprache >= 60) gymChance += 0.05;
          // Eltern-Engagement beeinflusst die Chance stark
          if (s.flags.elternEngagement === "hoch") gymChance += 0.12;
          else if (s.flags.elternEngagement === "niedrig") gymChance -= 0.07;
          else if (s.flags.elternEngagement === "vernachlaessigt") gymChance -= 0.15;
          // Wohnlage
          if (s.profile.wohnlage === "benachteiligte Lage") gymChance -= 0.05;
          gymChance = Math.min(gymChance, 0.88);
          gymChance = Math.max(gymChance, 0.04);
          s.flags.gymnasiumErreicht = Math.random() < gymChance;
          s.flags.lastGymChance = Math.round(gymChance * 100);
          if (s.flags.gymnasiumErreicht) {
            s.stats.bildung += 6; s.stats.sozial += 5;
            pushLog(s, "Gymnasium", "Du kommst ans Gymnasium!");
          } else {
            s.stats.stress += 5;
            pushLog(s, "Gymnasium", "Kein Gymnasium ‚Äì du gehst auf Realschule oder Hauptschule.");
          }
        }
      }
    ]
  },

  gymnasium_ergebnis: {
    phase: "Sek I",
    title: "üìã Ergebnis der Schulzuweisung (10 Jahre)",
    text: "",  // wird dynamisch gesetzt
    reflection: "Dieses Ergebnis zeigt: Dein Einsatz z√§hlt ‚Äì aber dein famili√§rer Hintergrund z√§hlt noch mehr. Das ist soziale Ungerechtigkeit.",
    choices: [
      { label: "‚û°Ô∏è Weiter: Sek I beginnt", next: "sek1_digital" }
    ]
  },

  sek1_digital: {
    phase: "Sek I",
    title: "üíª Digitaler Unterricht ‚Äì Ger√§t vorhanden? (13 Jahre)",
    text: "Es gibt viel digitalen Unterricht. Wer ein Laptop oder Tablet hat, kann viel leichter lernen. Aber nicht alle haben ein Ger√§t.",
    reflection: "Ein Computer ist heute genauso wichtig f√ºr die Schule wie fr√ºher ein Schulbuch!",
    choices: [
      {
        label: "üíª Du hast Laptop & gutes Internet",
        next: "praktikum",
        requires: (s) => s.stats.geld >= 50 || s.flags.hatLaptop === true,
        lockReason: "‚õî Kein Ger√§t vorhanden und nicht genug Geld f√ºr einen Kauf.",
        effects: (s) => {
          s.flags.hatLaptop = true;
          s.stats.bildung += 8; s.stats.stress -= 2;
          pushLog(s, "Digital", "Mit Laptop l√§uft der Unterricht viel besser!");
        },
        note: "Wer Zugang hat, lernt effektiver ‚Äì ein gro√üer Vorteil."
      },
      {
        label: "üì¶ Schulger√§t ausleihen (falls verf√ºgbar)",
        next: "praktikum",
        effects: (s) => {
          const p = 0.35 + (s.flags.hatFoerderung ? 0.20 : 0) + (s.profile.region === "Gro√üstadt" ? 0.10 : 0);
          if (Math.random() < p){
            s.flags.hatLaptop = true;
            s.stats.bildung += 6; s.stats.stress += 1;
            pushLog(s, "Digital", "Du bekommst ein Leihger√§t ‚Äì super, auch wenn es manchmal kompliziert ist.");
          } else {
            s.flags.hatLaptop = false;
            s.stats.bildung -= 2; s.stats.stress += 7;
            pushLog(s, "Digital", "Kein Ger√§t verf√ºgbar. Du verpasst oft wichtige Inhalte.");
          }
        },
        note: "Ob ein Ger√§t verf√ºgbar ist, h√§ngt von der Schule und dem Wohnort ab."
      },
      {
        label: "üì± Nur Handy ‚Äì irgendwie geht's",
        next: "praktikum",
        effects: { bildung: -1, stress: +6, sozial: -1 },
        note: "Auf dem Handy zu lernen ist viel schwieriger ‚Äì aber manchmal die einzige M√∂glichkeit."
      }
    ]
  },

  praktikum: {
    phase: "Sek I",
    title: "üîç Praktikumssuche (15 Jahre)",
    text: "Du brauchst ein Sch√ºlerpraktikum. Manche finden schnell einen Platz ‚Äì √ºber Kontakte der Eltern. Andere m√ºssen viele Bewerbungen schreiben.",
    reflection: "Netzwerke sind unsichtbare T√ºr√∂ffner ‚Äì wer sie hat, merkt es kaum. Wer sie nicht hat, k√§mpft.",
    choices: [
      {
        label: "ü§ù Praktikum √ºber Bekannte der Familie",
        next: "sek1_konsum",
        requires: (s) => s.stats.sozial >= 55,
        lockReason: "‚õî Keine passenden Kontakte vorhanden.",
        effects: { sozial: +6, bildung: +4, stress: -2 },
        note: "Kontakte sparen Zeit und erh√∂hen die Chancen enorm."
      },
      {
        label: "‚úâÔ∏è Bewerbungen schreiben (mit Hilfe)",
        next: "sek1_konsum",
        requires: (s) => s.stats.sprache >= 50,
        lockReason: "‚õî Bewerbungen auf Deutsch schreiben ist ohne Hilfe sehr schwierig.",
        effects: { bildung: +3, stress: +2, sozial: +2 },
        note: "Bewerbungen schreiben ist eine F√§higkeit ‚Äì die manche zuhause lernen, andere nicht."
      },
      {
        label: "üí™ Alleine versuchen, viele Absagen",
        next: "sek1_konsum",
        effects: (s) => {
          const p = 0.25 + (s.stats.sprache/250) + (s.stats.bildung/300);
          if (Math.random() < p){
            s.stats.bildung += 4; s.stats.stress += 3; s.stats.sozial += 1;
            pushLog(s, "Praktikum", "Du findest etwas! Aber der Weg dahin war ersch√∂pfend.");
          } else {
            s.stats.bildung += 1; s.stats.stress += 8; s.stats.sozial -= 2;
            pushLog(s, "Praktikum", "Viele Absagen. Das frustriert ‚Äì obwohl du dich wirklich bem√ºhst.");
          }
        },
        note: "Absagen haben nicht immer mit Leistung zu tun."
      }
    ]
  },

  sek1_konsum: {
    phase: "Sek I / Oberstufe",
    title: "üëü Markensachen & Dazugeh√∂ren (16 Jahre)",
    text: "In deiner Klasse tragen pl√∂tzlich viele teure Sneaker, Markenjacken und die neuesten Handys. Es gibt eine unsichtbare Grenze: Wer die richtigen Sachen hat, geh√∂rt dazu ‚Äì wer nicht, f√§llt auf.\n\nWie gehst du damit um?",
    reflection: "Konsumzwang unter Jugendlichen ist real ‚Äì er entsteht oft nicht aus Oberfl√§chlichkeit, sondern aus dem tiefen Wunsch nach Zugeh√∂rigkeit.",
    choices: [
      {
        label: "üõçÔ∏è Eltern kaufen Markensachen",
        next: "sek1_fuehrerschein",
        requires: (s) => s.stats.geld >= 55,
        lockReason: "‚õî Das Geld reicht f√ºr teure Markensachen nicht.",
        effects: { geld: -18, sozial: +7, stress: -4 },
        note: "Zugeh√∂rigkeit erkauft ‚Äì aber sie funktioniert. Zumindest kurzfristig."
      },
      {
        label: "üîÑ G√ºnstige Alternativen / Second Hand",
        next: "sek1_fuehrerschein",
        effects: (s) => {
          const p = 0.5 + (s.stats.sozial / 200);
          if (Math.random() < p) {
            s.stats.sozial += 2; s.stats.stress -= 1;
            pushLog(s, "Konsum", "Mit Second Hand kommt man irgendwie durch ‚Äì und manche finden es sogar cool.");
          } else {
            s.stats.sozial -= 3; s.stats.stress += 4;
            pushLog(s, "Konsum", "Nicht alle akzeptieren g√ºnstiger Kleidung ‚Äì du wirst manchmal ausgeschlossen.");
          }
        },
        note: "Manche finden das authentisch ‚Äì andere machen sich lustig. H√§ngt stark von der Klasse ab."
      },
      {
        label: "üòî Keine Markensachen ‚Äì Ausgrenzung",
        next: "sek1_fuehrerschein",
        requires: (s) => s.stats.geld < 35 || s.flags.elternEngagement === "vernachlaessigt",
        lockReason: "‚õî Diese Option betrifft nur Kinder mit wenig Geld oder vernachl√§ssigenden Eltern.",
        effects: { sozial: -8, stress: +9, bildung: -3 },
        note: "Wenn man nie die richtigen Sachen hat, zieht man sich zur√ºck ‚Äì und f√ºhlt sich unsichtbar."
      },
      {
        label: "üí¨ Eigene Identit√§t entwickeln, egal was andere sagen",
        next: "sek1_fuehrerschein",
        requires: (s) => s.stats.sozial >= 50 || s.stats.bildung >= 60,
        lockReason: "‚õî Daf√ºr fehlen gerade Selbstbewusstsein und R√ºckhalt.",
        effects: { bildung: +4, stress: +3, sozial: -1 },
        note: "Mutig ‚Äì aber kostet Kraft. Man braucht ein starkes Selbstbewusstsein oder gute Freunde."
      }
    ]
  },

  sek1_fuehrerschein: {
    phase: "Oberstufe",
    title: "üöó F√ºhrerschein & Mobilit√§t (17‚Äì18 Jahre)",
    text: "Mit 17 k√∂nnen manche den F√ºhrerschein machen ‚Äì das kostet 2.000‚Äì3.000 Euro. Und zum 18. Geburtstag bekommen manche Jugendliche sogar ein eigenes Auto geschenkt.\n\nWas ist bei dir m√∂glich?",
    reflection: "Mobilit√§t bedeutet Freiheit ‚Äì und Freiheit ist ungleich verteilt. Wer kein Auto hat und auf dem Land wohnt, hat deutlich weniger M√∂glichkeiten f√ºr Jobs, Ausbildung und Freizeit.",
    choices: [
      {
        label: "üéÅ Auto zum 18. Geburtstag geschenkt",
        next: "sek1_zukunft",
        requires: (s) => s.stats.geld >= 70 && s.flags.elternEngagement !== "vernachlaessigt",
        lockReason: "‚õî Das ist f√ºr deine Familie finanziell nicht m√∂glich.",
        effects: (s) => {
          s.flags.hatFuehrerschein = true; s.flags.hatAuto = true;
          s.stats.sozial += 10; s.stats.stress -= 6; s.stats.geld -= 5;
          pushLog(s, "üöó Auto!", "Zum 18. ein Auto ‚Äì Freiheit und Status auf einmal.");
        },
        note: "In Deutschland bekommen ca. 10% der 18-J√§hrigen ein Auto geschenkt ‚Äì fast ausschlie√ülich aus wohlhabenden Familien."
      },
      {
        label: "üí≥ Eltern zahlen den F√ºhrerschein",
        next: "sek1_zukunft",
        requires: (s) => s.stats.geld >= 45,
        lockReason: "‚õî 2.500 Euro f√ºr den F√ºhrerschein sind gerade nicht drin.",
        effects: (s) => {
          s.flags.hatFuehrerschein = true;
          s.stats.sozial += 5; s.stats.stress -= 3; s.stats.geld -= 25;
          pushLog(s, "üöó F√ºhrerschein", "F√ºhrerschein geschafft ‚Äì du bist mobiler, aber noch kein Auto.");
        },
        note: "F√ºhrerschein ohne Auto: mehr Freiheit, aber du bist noch auf Bus & Bahn angewiesen."
      },
      {
        label: "üöå Kein F√ºhrerschein ‚Äì √ñPNV und zu Fu√ü",
        next: "sek1_zukunft",
        effects: (s) => {
          if (s.profile.region === "L√§ndlicher Raum") {
            s.stats.stress += 8; s.stats.sozial -= 5; s.stats.bildung -= 2;
            pushLog(s, "üöå Kein F√ºhrerschein", "Auf dem Land ohne Auto: Praktikumspl√§tze, Freunde, Ausbildung ‚Äì alles schwerer erreichbar.");
          } else {
            s.stats.stress += 3; s.stats.sozial -= 2;
            pushLog(s, "üöå Kein F√ºhrerschein", "In der Stadt geht es ohne Auto ‚Äì aber manche Chancen fallen weg.");
          }
        },
        note: "In l√§ndlichen Regionen ist kein F√ºhrerschein eine echte Einschr√§nkung f√ºr Ausbildung und Beruf."
      }
    ]
  },

  sek1_zukunft: {
    phase: "Oberstufe",
    title: "üéØ Was kommt nach der Schule? (18 Jahre)",
    text: "Du bist jetzt 18 Jahre alt. Die Weichen f√ºr deine Zukunft werden gestellt. Gymnasium und Abitur? Ausbildung? Oder bist du noch unsicher?\n\nWas ist f√ºr dich realistisch?",
    reflection: "In Deutschland h√§ngt die Berufswahl stark vom sozialen Hintergrund ab ‚Äì nicht von Talent oder Wunsch. Kinder aus Akademikerfamilien studieren dreimal h√§ufiger.",
    choices: [
      {
        label: "üéì Abitur & Studium anstreben",
        next: "abschluss",
        requires: (s) => s.flags.gymnasiumErreicht && s.stats.bildung >= 55,
        lockReason: "‚õî Ohne Gymnasium ist der direkte Weg zur Uni versperrt. Der Zweite Bildungsweg ist m√∂glich ‚Äì aber lang.",
        effects: { bildung: +8, stress: +5, sozial: +4 },
        note: "Studieren √∂ffnet T√ºren ‚Äì aber kostet Zeit, Geld und Nerven."
      },
      {
        label: "üîß Ausbildung beginnen",
        next: "abschluss",
        effects: (s) => {
          s.stats.geld += 10; s.stats.bildung += 5; s.stats.stress += 3;
          pushLog(s, "Ausbildung", "Du startest eine Ausbildung ‚Äì Einkommen, Praxis, Zukunft.");
        },
        note: "Eine gute Ausbildung ist oft untersch√§tzt ‚Äì und kann langfristig sehr erfolgreich sein."
      },
      {
        label: "‚ùì Noch unsicher ‚Äì erstmal jobben",
        next: "abschluss",
        effects: (s) => {
          s.stats.geld += 6; s.stats.stress += 2;
          pushLog(s, "Orientierung", "Jobben und √ºberlegen ‚Äì aber die Zeit l√§uft.");
        },
        note: "Orientierung braucht Zeit ‚Äì aber je l√§nger, desto schwerer wird der Wiedereinstieg."
      },
      {
        label: "üòî Kein Plan, keine Unterst√ºtzung",
        next: "abschluss",
        requires: (s) => s.flags.elternEngagement === "vernachlaessigt" || s.stats.bildung < 35,
        lockReason: "‚õî Du hast genug Orientierung und Unterst√ºtzung, um Pl√§ne zu schmieden.",
        effects: { stress: +10, sozial: -5, bildung: -3 },
        note: "Ohne Unterst√ºtzung und ohne Plan droht die Gefahr, ganz aus dem Bildungssystem herauszufallen."
      }
    ]
  },

  abschluss: {
    phase: "Abschluss (18 Jahre)",
    title: "üìä R√ºckblick mit 18 Jahren",
    text: "Du bist jetzt 18 Jahre alt ‚Äì vollj√§hrig! Das Spiel endet hier, aber dein Leben geht weiter.\n\nSchau auf deinen Weg zur√ºck: Was h√§ttest du gerne anders gehabt? Was war nicht in deiner Hand?",
    reflection: "Diskutiert in der Klasse: Welche EINE √Ñnderung im System w√ºrde am meisten helfen?",
    choices: [
      { label: "üìà Ergebnis anzeigen", next: "result" },
      { label: "üîÑ Nochmal spielen", next: "__NEW__" }
    ]
  },

  result: {
    phase: "Ende",
    title: "üèÅ Ergebnis & Auswertung",
    text: "Das Spiel zeigt eine ungef√§hre Tendenz ‚Äì kein Urteil √ºber echte Menschen!\n\nEin Mensch ist keine Zahl. Aber Zahlen zeigen Muster in einem System.",
    reflection: "In der Realit√§t schaffen es viele Menschen trotz schwieriger Bedingungen. Aber es sollte nicht vom Gl√ºck abh√§ngen.",
    choices: [
      { label: "‚ùì Reflexionsfragen f√ºr die Klasse", next: "reflection_questions" },
      { label: "üîÑ Neues Spiel starten", next: "__NEW__" }
    ]
  },

  alltag_handy: {
    phase: "Alltag",
    title: "üì± Dein Alltag zuhause ‚Äì Handy & Technik (9 Jahre)",
    text: "",  // dynamisch gesetzt
    reflection: "Ob man ein Ger√§t hat oder nicht, entscheidet die Familie ‚Äì nicht das Kind. Aber es beeinflusst, wie man am sozialen Leben und am Lernen teilnehmen kann.",
    autoResolve: (s) => {
      if (s.stats.geld < 25) {
        s.stats.stress += 5; s.stats.sozial -= 4;
        pushLog(s, "üì± Kein Handy", "Ihr habt kein Geld f√ºr ein eigenes Ger√§t. In der Klasse reden alle √ºber TikTok und WhatsApp-Gruppen ‚Äì du kannst nicht mitmachen.");
        return "üìµ Du hast kein eigenes Ger√§t. Das Geld reicht nicht.\n\nIn der Klasse gibt es Gruppen-Chats und gemeinsame Spiele ‚Äì aber du kannst nicht mitmachen. Das isoliert dich, ohne dass du etwas daf√ºr kannst.\n\n‚Üí Soziale Kontakte ‚Äì4, Stress +5";
      } else if (s.stats.geld < 50) {
        s.stats.sozial += 1;
        pushLog(s, "üì± Altes Handy", "Du hast ein altes Ger√§t ‚Äì irgendwie geht's.");
        return "üì≤ Du hast ein altes Handy, das gerade noch funktioniert.\n\nManche Apps laufen nicht richtig, aber du kannst zumindest in Gruppen-Chats mitmachen.\n\n‚Üí Kein gro√üer Vor- oder Nachteil";
      } else if (s.flags.elternAkademiker) {
        s.stats.bildung += 4; s.stats.stress -= 2;
        pushLog(s, "üì± Handy mit Regeln", "Deine Eltern setzen Grenzen beim Bildschirm ‚Äì das hilft dir beim Lernen.");
        return "üì± Du hast ein eigenes Ger√§t und deine Eltern achten auf sinnvolle Nutzung.\n\nSie erkl√§ren dir, welche Apps gut sind ‚Äì und wann Schluss ist. Das hilft dir beim Lernen.\n\n‚Üí Bildung +4, Stress ‚Äì2";
      } else {
        s.stats.sozial += 3; s.stats.bildung -= 2;
        pushLog(s, "üì± Viel Bildschirmzeit", "Kein Ger√§t-Limit ‚Äì du spielst viel, lernst daf√ºr weniger.");
        return "üéÆ Du hast ein Ger√§t ohne klare Regeln.\n\nDu spielst viel und schaust Videos ‚Äì das ist entspannend, aber du lernst weniger und schl√§fst manchmal schlechter.\n\n‚Üí Sozial +3, Bildung ‚Äì2";
      }
    },
    choices: [{ label: "‚û°Ô∏è Weiter", next: "alltag_ernaehrung" }]
  },

  alltag_ernaehrung: {
    phase: "Alltag",
    title: "üçé Mittagessen in der Schule (9 Jahre)",
    text: "",
    reflection: "Wer hungrig in der Schule sitzt, kann sich schlecht konzentrieren ‚Äì egal wie klug man ist. Ern√§hrung ist auch eine soziale Frage.",
    autoResolve: (s) => {
      // Vernachl√§ssigende Eltern: kein Interesse, kein Essen ‚Äì aber nur wenn auch kein Geld
      if (s.flags.elternEngagement === "vernachlaessigt" && s.profile.income !== "hoch") {
        s.stats.stress += 8; s.stats.bildung -= 5; s.stats.sozial -= 3;
        pushLog(s, "ü•™ Kein Essen", "Niemand hat sich darum gek√ºmmert ‚Äì du gehst oft hungrig in die Schule.");
        return "üòî Niemand hat sich darum gek√ºmmert, dass du mittags etwas zu essen hast.\n\nDu gehst oft hungrig in die Schule. Das ist schwer zu erkl√§ren, und noch schwerer, sich dabei zu konzentrieren.\n\n‚Üí Bildung ‚Äì5, Stress +8, Sozial ‚Äì3";
      }
      // Hohes Einkommen: Essen ist kein Problem, immer verf√ºgbar
      if (s.profile.income === "hoch") {
        s.stats.bildung += 2; s.stats.stress -= 2;
        pushLog(s, "üçΩÔ∏è Warmes Mittagessen", "Deine Eltern zahlen das Schulessen ‚Äì kein Problem.");
        return "üçΩÔ∏è Deine Familie zahlt das Schulessen problemlos.\n\nDu isst t√§glich warm und regelm√§√üig in der Mensa. Das ist f√ºr dich selbstverst√§ndlich ‚Äì f√ºr viele Mitsch√ºler nicht.\n\n‚Üí Bildung +2, Stress ‚Äì2";
      }
      // Niedriges Einkommen + F√∂rderung: Bildungspaket
      if (s.profile.income === "niedrig" && s.flags.hatFoerderung) {
        s.stats.stress -= 2; s.stats.bildung += 3;
        pushLog(s, "üçΩÔ∏è Bildungspaket", "Du bekommst kostenloses Mittagessen √ºber das Bildungspaket.");
        return "üçΩÔ∏è Du bekommst kostenloses Mittagessen √ºber das Bildungspaket.\n\nDas klingt gut ‚Äì aber der Antrag war kompliziert, und manche Kinder merken, dass du zur Gruppe geh√∂rst, die nicht selbst zahlt. Trotzdem: Du bist satt und kannst dich konzentrieren.\n\n‚Üí Bildung +3, Stress ‚Äì2";
      }
      // Niedriges Einkommen OHNE F√∂rderung
      if (s.profile.income === "niedrig") {
        s.stats.stress += 5; s.stats.bildung -= 4; s.stats.sozial -= 2;
        pushLog(s, "ü•™ Kein warmes Essen", "Kein Geld f√ºrs Mittagessen und kein Bildungspaket ‚Äì du hast oft Hunger.");
        return "üòî Das Geld reicht nicht f√ºr das Schulessen und das Bildungspaket wurde nicht beantragt.\n\nManchmal bringst du ein Brot mit, manchmal gar nichts. Hunger macht es schwer, sich zu konzentrieren.\n\n‚Üí Bildung ‚Äì4, Stress +5, Sozial ‚Äì2";
      }
      // Mittleres Einkommen: zahlen, aber sp√ºrbar
      s.stats.geld -= 8; s.stats.bildung += 2; s.stats.stress -= 2;
      pushLog(s, "üçΩÔ∏è Mittagessen bezahlt", "Deine Eltern zahlen das Mittagessen.");
      return "üí∂ Deine Eltern bezahlen das Mittagessen jeden Tag.\n\nDas kostet die Familie monatlich 60‚Äì90 Euro ‚Äì aber du isst warm und regelm√§√üig. Das tut dir gut.\n\n‚Üí Bildung +2, Stress ‚Äì2, Geld ‚Äì8";
    },
    choices: [{ label: "‚û°Ô∏è Weiter", next: "alltag_freizeit" }]
  },

  alltag_freizeit: {
    phase: "Alltag",
    title: "‚öΩ Freizeit & Hobbys (10 Jahre)",
    text: "",  // dynamisch gesetzt
    reflection: "Freizeitaktivit√§ten kosten Geld, Zeit und manchmal Transportm√∂glichkeiten. Kinder aus wohlhabenderen Familien nehmen dreimal h√§ufiger an Vereinen teil.",
    autoResolve: (s) => {
      if (s.stats.geld >= 50) {
        s.stats.geld -= 10; s.stats.sozial += 8; s.stats.stress -= 5; s.stats.bildung += 2;
        pushLog(s, "‚öΩ Vereinsmitglied", "Du bist in einem Verein ‚Äì Fu√üball, Musik oder Turnen.");
        return "üèÜ Du bist Mitglied in einem Verein!\n\nOb Fu√üball, Musikschule oder Turnen ‚Äì du hast feste Trainingszeiten, neue Freundschaften und Erfolgserlebnisse au√üerhalb der Schule. Das st√§rkt dich.\n\n‚Üí Sozial +8, Stress ‚Äì5, Bildung +2, Geld ‚Äì10";
      } else if (s.profile.region === "Gro√üstadt" || s.flags.hatFoerderung) {
        s.stats.sozial += 4; s.stats.stress -= 2;
        pushLog(s, "üÜì Kostenloses Angebot", "Du nimmst an einem kostenlosen Angebot teil.");
        return "üÜì Deine Stadt hat kostenlose Angebote ‚Äì eine Schul-AG oder ein Gemeindeprogramm.\n\nDu machst mit! Es ist nicht dasselbe wie ein richtiger Verein, aber du triffst andere Kinder und bewegst dich.\n\n‚Üí Sozial +4, Stress ‚Äì2";
      } else if (s.profile.region === "L√§ndlicher Raum") {
        s.stats.sozial -= 3; s.stats.stress += 3;
        pushLog(s, "üè† Kaum Angebote", "Auf dem Land gibt es kaum Freizeitangebote f√ºr Kinder ohne Geld.");
        return "üè† Auf dem Land gibt es kaum kostenlose Freizeitangebote.\n\nOhne Auto und ohne Geld kannst du nicht zu Vereinen oder Kursen. Du bleibst zuhause ‚Äì hilfst im Haushalt oder schaust fern.\n\n‚Üí Sozial ‚Äì3, Stress +3";
      } else {
        s.stats.sozial -= 2; s.stats.stress += 2;
        pushLog(s, "üè† Zuhause bleiben", "Das Geld reicht nicht f√ºr Vereinsbeitr√§ge.");
        return "üòê Das Geld reicht nicht f√ºr Vereinsmitgliedschaften.\n\nDu bleibst nachmittags oft zuhause. Manchmal hilfst du im Haushalt, manchmal schaust du Serien. Strukturierte Aktivit√§ten fehlen dir.\n\n‚Üí Sozial ‚Äì2, Stress +2";
      }
    },
    choices: [{ label: "‚û°Ô∏è Weiter", next: "alltag_schlaf" }]
  },

  alltag_schlaf: {
    phase: "Alltag",
    title: "üò¥ Schlaf & Wohnsituation (10 Jahre)",
    text: "",  // dynamisch gesetzt
    reflection: "Schlafmangel wirkt wie ein Unterrichtsausfall ‚Äì das Gehirn kann sich schlechter konzentrieren. Laut Bertelsmann-Stiftung haben arme Kinder oft kein eigenes Zimmer und damit keinen R√ºckzugsort zum Lernen und Erholen.",
    autoResolve: (s) => {
      // Forschung: ~90%+ Gymnasiasten/Akademikerkinder haben eigenes Zimmer
      // ~75% Hauptsch√ºler haben eigenes Zimmer
      // Kinder in Armut: oft kein eigenes Zimmer (beengte Verh√§ltnisse)
      // ‚Üí Eigenes Zimmer: Standard bei mittlerem/hohem Einkommen, Ausnahme bei Armut
      const hatEigenesZimmer =
        s.profile.income === "hoch" ||
        (s.profile.income === "mittel" && s.profile.family !== "viele Kinder" && Math.random() < 0.82) ||
        (s.profile.income === "niedrig" && s.profile.wohnlage !== "benachteiligte Lage" && Math.random() < 0.30);

      if (hatEigenesZimmer) {
        s.stats.stress -= 8; s.stats.bildung += 4;
        s.flags.hatEigenesZimmer = true;
        pushLog(s, "üõèÔ∏è Eigenes Zimmer", "Du hast ein eigenes Zimmer ‚Äì Ruhe, R√ºckzug, guter Schlaf.");
        const extra = s.profile.income === "hoch" ? "\n\nEin eigenes Zimmer mit Schreibtisch, ruhiger Umgebung ‚Äì f√ºr dich ist das normal. F√ºr viele Mitsch√ºler nicht." : "";
        return "üõèÔ∏è Du hast ein eigenes Zimmer.\n\nEs ist ruhig, du kannst deine Sachen ordnen und ungest√∂rt lernen und schlafen. Das klingt selbstverst√§ndlich ‚Äì ist es aber nicht f√ºr alle." + extra + "\n\n‚Üí Bildung +4, Stress ‚Äì8";
      } else if (s.profile.income === "niedrig" || s.profile.wohnlage === "benachteiligte Lage") {
        s.stats.stress += 9; s.stats.bildung -= 5; s.stats.sozial -= 2;
        s.flags.hatEigenesZimmer = false;
        pushLog(s, "üòµ Kein eigenes Zimmer", "Beengte Wohnung ‚Äì kein R√ºckzugsort, schlechter Schlaf.");
        return "üòµ Ihr wohnt eng. Du teilst das Zimmer, manchmal ist es laut ‚Äì Streit, Fernseher, Ger√§usche von nebenan.\n\nDu schl√§fst schlecht. Morgens bist du m√ºde und kannst dich in der Schule kaum konzentrieren. Einen ruhigen Platz zum Lernen gibt es nicht.\n\n‚Üí Bildung ‚Äì5, Stress +9, Sozial ‚Äì2";
      } else {
        s.stats.stress += 3; s.stats.bildung += 1;
        s.flags.hatEigenesZimmer = false;
        pushLog(s, "üõãÔ∏è Geteiltes Zimmer", "Du teilst ein Zimmer ‚Äì meistens okay, manchmal laut.");
        return "üõãÔ∏è Du teilst ein Zimmer mit einem Geschwisterkind.\n\nMeistens geht es gut ‚Äì manchmal ist es laut und du schl√§fst nicht genug. Ein eigener R√ºckzugsort w√§re sch√∂n, aber er fehlt.\n\n‚Üí Bildung +1, Stress +3";
      }
    },
    choices: [{ label: "‚û°Ô∏è Weiter", next: "alltag_arzt" }]
  },

  alltag_arzt: {
    phase: "Alltag",
    title: "üè• Gesundheit & Unterst√ºtzung (10 Jahre)",
    text: "",  // dynamisch gesetzt
    reflection: "Kinder, die schlecht sehen oder h√∂ren, werden manchmal f√§lschlicherweise als 'weniger klug' eingesch√§tzt. Dabei brauchen sie nur die richtige Unterst√ºtzung ‚Äì die nicht alle bekommen.",
    autoResolve: (s) => {
      if (s.stats.geld >= 45 || s.flags.elternAkademiker) {
        s.stats.bildung += 6; s.stats.stress -= 4;
        pushLog(s, "üëì Brille bekommen", "Sehproblem erkannt ‚Äì du bekommst schnell eine Brille.");
        return "üëì Bei einer Untersuchung stellt sich heraus: Du siehst nicht gut.\n\nDeine Eltern reagieren sofort ‚Äì Augenarzttermin, neue Brille, Problem gel√∂st. In der Schule l√§uft es danach viel besser.\n\n‚Üí Bildung +6, Stress ‚Äì4";
      } else if (s.stats.geld >= 25) {
        s.stats.stress += 5; s.stats.bildung -= 3;
        pushLog(s, "‚è≥ Lange Wartezeit", "Du wartest monatelang auf einen Kassentermin.");
        return "‚è≥ Du siehst schlecht ‚Äì das wurde festgestellt. Aber ihr habt keinen Privatarzt und der Kassentermin ist erst in acht Monaten.\n\nIn der Zwischenzeit verpasst du vieles an der Tafel. Deine Lehrerin denkt, du passt nicht auf.\n\n‚Üí Bildung ‚Äì3, Stress +5";
      } else {
        s.stats.stress += 7; s.stats.bildung -= 8;
        pushLog(s, "ü§∑ Unbemerkt geblieben", "Das Sehproblem bleibt unentdeckt ‚Äì niemand k√ºmmert sich.");
        return "üòî Du siehst schlecht ‚Äì aber niemand bemerkt es.\n\nDeine Eltern haben gerade andere Sorgen. In der Schule k√§mpfst du jeden Tag, ohne zu wissen warum. Die Lehrerin glaubt, du bist unaufmerksam.\n\n‚Üí Bildung ‚Äì8, Stress +7";
      }
    },
    choices: [{ label: "‚û°Ô∏è Weiter", next: "uebergang" }]
  },

  reflection_questions: {
    phase: "Ende",
    title: "üí¨ Fragen f√ºr die Klassenrunde",
    text:
      "1Ô∏è‚É£  Wo hattest du wirklich eine freie Wahl ‚Äì und wo nicht?\n\n" +
      "2Ô∏è‚É£  Was hat dich am meisten √ºberrascht?\n\n" +
      "3Ô∏è‚É£  Warum kommen Kinder von Akademiker-Eltern so viel h√§ufiger aufs Gymnasium?\n\n" +
      "4Ô∏è‚É£  Welche Ver√§nderung im System w√ºrde am meisten helfen?\n    (z. B. kostenloses Essen, bessere Ger√§te, mehr F√∂rderung, weniger B√ºrokratie)\n\n" +
      "5Ô∏è‚É£  Vergleicht eure Spielverl√§ufe ‚Äì wer hatte gleiche Noten aber andere Ergebnisse?\n\n" +
      "6Ô∏è‚É£  Welche Alltagsdinge au√üerhalb der Schule haben deinen Weg beeinflusst? (Schlaf, Essen, Freizeit...)\n\n" +
      "7Ô∏è‚É£  Welche Zufallsereignisse sind euch passiert? Wie fair war das?\n\n" +
      "8Ô∏è‚É£  Was k√∂nntet ihr selbst tun ‚Äì und was braucht ihr Unterst√ºtzung von anderen?\n\n" +
      "9Ô∏è‚É£  Wenn ihr eine Sache im System √§ndern k√∂nntet: Was w√§re das?\n\n" +
      "üîü  Kennt ihr Menschen aus eurem Umfeld, denen es so ergangen ist wie im Spiel?",
    reflection: "Tipp: Vergleicht eure Notenschnitte am Ende ‚Äì und diskutiert, was dahinter steckt!",
    choices: [
      { label: "üîÑ Neu spielen", next: "__NEW__" }
    ]
  }
};

// ---------- Logic ----------
function pushLog(s, title, text){
  s.log.unshift({
    t: nowISO(),
    title,
    text
  });
  if (s.log.length > 10) s.log.length = 10;
}

function setPhaseAndAgeByScene(s, sceneId){
  const sc = SCENES[sceneId];
  if (!sc) return;
  s.phase = sc.phase || s.phase;
  const ageMap = {
    intro: 6, klassenfahrt: 8, hausaufgaben: 8, deutsch_ag: 9,
    alltag_handy: 9, alltag_ernaehrung: 9, alltag_freizeit: 10,
    alltag_schlaf: 10, alltag_arzt: 10,
    uebergang: 10, gymnasium_entscheidung: 10, gymnasium_ergebnis: 10,
    sek1_digital: 13, praktikum: 15,
    sek1_konsum: 16, sek1_fuehrerschein: 17, sek1_zukunft: 18,
    abschluss: 18, result: 18, reflection_questions: 18
  };
  if (sceneId in ageMap) s.age = ageMap[sceneId];
}

function applyEffects(s, effects){
  if (!effects) return;
  if (typeof effects === "function"){
    effects(s);
    normalizeStats(s);
    return;
  }
  for (const [k,v] of Object.entries(effects)){
    if (k === "flag" && Array.isArray(v)){
      const [fk, fv] = v;
      s.flags[fk] = fv;
      continue;
    }
    if (k in s.stats){
      s.stats[k] += v;
    }
  }
  normalizeStats(s);
}

function normalizeStats(s){
  s.stats.geld = clamp(s.stats.geld, 0, 100);
  s.stats.bildung = clamp(s.stats.bildung, 0, 100);
  s.stats.stress = clamp(s.stats.stress, 0, 100);
  s.stats.sprache = clamp(s.stats.sprache, 0, 100);
  s.stats.sozial = clamp(s.stats.sozial, 0, 100);
}

function computeOutcome(s){
  const score =
    0.40*s.stats.bildung +
    0.20*s.stats.sprache +
    0.15*s.stats.sozial +
    0.10*s.stats.geld +
    (-0.25)*s.stats.stress;

  // Maximaler theoretischer Score (alle Stats perfekt)
  const maxScore = 0.40*100 + 0.20*100 + 0.15*100 + 0.10*100 + (-0.25)*0;
  // = 40 + 20 + 15 + 10 = 85

  const pct = Math.round((Math.max(0, score) / maxScore) * 100);

  if (score >= 58) return { label: "üü¢ Gute Bildungschancen ‚Äì du bist auf einem stabilen Weg!", kind: "ok", score, maxScore, pct };
  if (score >= 40) return { label: "üü° Gemischte Chancen ‚Äì vieles h√§ngt von weiterer Unterst√ºtzung ab.", kind: "warn", score, maxScore, pct };
  if (score >= 22) return { label: "üî¥ Schwieriger Weg ‚Äì das System hat dir wenig R√ºckenwind gegeben.", kind: "danger", score, maxScore, pct };
  return { label: "üî¥ Sehr schwieriger Weg ‚Äì strukturelle Benachteiligung ist hier klar sichtbar.", kind: "danger", score, maxScore, pct };
}

function gotoScene(sceneId){
  if (sceneId === "__NEW__"){
    startNew();
    return;
  }
  if (sceneId === "__EXPORT__"){
    exportJSON();
    return;
  }

  if (!SCENES[sceneId]) return;

  state.currentScene = sceneId;
  setPhaseAndAgeByScene(state, sceneId);

  // Notenschnitt berechnen und speichern
  if (sceneId === "uebergang") {
    state.flags.noteGrundschule = computeGrade(state);
  }
  if (sceneId === "sek1_konsum") {
    state.flags.noteSek1 = computeGrade(state);
  }

  if (sceneId === "result"){
    const out = computeOutcome(state);
    pushLog(state, "Auswertung", `${out.label} (Score: ${Math.round(out.score)})`);
  }

  // Zufallsereignis pr√ºfen (nicht am Anfang, Ende oder bei √úberg√§ngen)
  const noEventScenes = ["intro","result","reflection_questions","gymnasium_ergebnis","abschluss"];
  if (!noEventScenes.includes(sceneId)) {
    const ev = rollRandomEvent(state);
    if (ev) {
      pendingEvent = ev;
    }
  }

  saveLocal();
  render();
}

function startNew(){
  state = rollStartState();
  saveLocal();
  render();
}

function resetAll(){
  localStorage.removeItem("planspiel_state_v1");
  startNew();
}

function saveLocal(){
  localStorage.setItem("planspiel_state_v1", JSON.stringify(state));
}

function loadLocal(){
  const raw = localStorage.getItem("planspiel_state_v1");
  if (!raw) return null;
  try{
    const parsed = JSON.parse(raw);
    if (!parsed || !parsed.stats || !parsed.profile) return null;
    return parsed;
  } catch(e){
    return null;
  }
}

function exportJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `planspiel_${state.id}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// ---------- Render ----------
function el(id){ return document.getElementById(id); }

function renderPills(){
  const pb = el("pillbar");
  pb.innerHTML = "";
  el("ageLabel").textContent = state.age;
  const pills = [
    ["Region", state.profile.region],
    ["Wohnlage", state.profile.wohnlage],
    ["Familie", state.profile.family],
    ["Einkommen", state.profile.income],
    ["Sprache zuhause", state.profile.languageHome],
    ["Eltern-Bildung", state.profile.elternBildung],
    ["Eltern-Engagement", {
      hoch: "‚ù§Ô∏è Sehr engagiert",
      mittel: "üôÇ Mittel",
      niedrig: "üòê Wenig Zeit",
      vernachlaessigt: "üòî Kaum vorhanden"
    }[state.flags.elternEngagement] || state.flags.elternEngagement]
  ];
  for (const [k,v] of pills){
    if (!v) continue;
    const d = document.createElement("div");
    d.className = "pill";
    d.innerHTML = `<span class="pill-label">${escapeHTML(k)}</span><b>${escapeHTML(v)}</b>`;
    pb.appendChild(d);
  }
}

function renderMeta(){
  const m = el("meta");
  m.innerHTML = "";
  const rows = [
    ["üè´ Phase", state.phase],
    ["üíª Laptop", state.flags.hatLaptop ? "‚úÖ ja" : "‚ùå nein"],
    ["üéì Gymnasium", state.flags.gymnasiumErreicht ? "‚úÖ erreicht" : (state.age >= 11 ? "‚ùå nein" : "noch offen")],
    [
      "üìã F√∂rderung (BuT)",
      state.profile.income === "niedrig"
        ? (state.flags.hatFoerderung ? "‚úÖ Antrag m√∂glich" : "‚ùå Nicht beantragt / unbekannt")
        : "Kein Anspruch"
    ]
  ];
  for (const [k,v] of rows){
    const div = document.createElement("div");
    div.className = "kv";
    div.innerHTML = `<span>${escapeHTML(k)}</span><span>${escapeHTML(v)}</span>`;
    m.appendChild(div);
  }
}

function statBar(label, value, isInverse=false){
  const wrap = document.createElement("div");
  wrap.className = "stat";
  const row = document.createElement("div");
  row.className = "row";
  row.innerHTML = `<span>${escapeHTML(label)}</span><span class="val">${Math.round(value)}/100</span>`;
  const bar = document.createElement("div");
  bar.className = "bar" + (isInverse ? " danger" : "");
  const fill = document.createElement("div");
  fill.style.width = `${clamp(value,0,100)}%`;
  bar.appendChild(fill);
  wrap.appendChild(row);
  wrap.appendChild(bar);
  return wrap;
}

function renderStats(){
  const s = el("stats");
  s.innerHTML = "";
  s.appendChild(statBar("üí∞ Geld & Mittel", state.stats.geld));
  s.appendChild(statBar("üìö Bildung & Wissen", state.stats.bildung));
  s.appendChild(statBar("üó£Ô∏è Deutschkenntnisse", state.stats.sprache));
  s.appendChild(statBar("ü§ù Soziale Kontakte", state.stats.sozial));
  s.appendChild(statBar("üò∞ Stress & Belastung", state.stats.stress, true));
}

function renderLog(){
  const l = el("log");
  l.innerHTML = "";
  if (!state.log.length){
    l.innerHTML = `<div class="entry">Noch keine Eintr√§ge.</div>`;
    return;
  }
  for (const e of state.log){
    const div = document.createElement("div");
    div.className = "entry";
    div.innerHTML = `<b>${escapeHTML(e.title)}</b><div style="margin-top:4px">${escapeHTML(e.text)}</div>`;
    l.appendChild(div);
  }
}

function renderSystemHint(){
  // removed ‚Äì replaced by cleaner inline hints
}

function renderScene(){
  const sc = SCENES[state.currentScene];
  if (!sc) return;

  el("phaseLabel").textContent = sc.phase || state.phase;
  el("sceneTitle").textContent = sc.title;

  // autoResolve-Szenen: Text wird durch Profil-Logik gesetzt, nur "Weiter"-Button
  let sceneText = sc.text;
  const resolvedKey = "resolvedText_" + state.currentScene;
  if (sc.autoResolve) {
    if (!state.flags[resolvedKey]) {
      // Erste Anzeige: autoResolve ausf√ºhren und Text speichern
      const resolved = sc.autoResolve(state);
      state.flags[resolvedKey] = resolved || "‚Äì";
      state.flags["resolved_" + state.currentScene] = true;
      normalizeStats(state);
      saveLocal();
      checkAchievements(state);
      renderStats();
      renderGrade();
      renderLog();
    }
    // Immer gespeicherten Text anzeigen
    sceneText = state.flags[resolvedKey];
  }

  // Dynamischer Text f√ºr gymnasium_ergebnis
  if (state.currentScene === "gymnasium_ergebnis") {
    if (state.flags.gymnasiumErreicht) {
      sceneText = "üéâ Gl√ºckwunsch! Du kommst ans Gymnasium!\n\nDein famili√§rer Hintergrund und deine Leistungen haben geholfen. Aber bedenke: Andere Kinder mit √§hnlichen Noten hatten nicht so viel Gl√ºck.";
    } else {
      sceneText = "üòï Es hat nicht geklappt mit dem Gymnasium.\n\nDu gehst auf die Realschule oder Hauptschule. Das bedeutet nicht, dass du nicht klug bist ‚Äì die Chancen waren einfach ungleich verteilt.";
    }
    if (state.flags.lastGymChance !== undefined) {
      sceneText += "\n\nüìä Deine berechnete Gymnasium-Chance lag bei " + state.flags.lastGymChance + "%.";
    }
  }
  el("sceneText").textContent = sceneText;

  // Gymnasium-Chance-Box anzeigen
  const gymBox = el("gymchanceContainer");
  gymBox.innerHTML = "";
  if (sc.gymChance && state.currentScene === "gymnasium_entscheidung") {
    let chance = 0.15;
    if (state.flags.elternAkademiker) chance += 0.28;
    if (state.profile.income === "hoch") chance += 0.12;
    if (state.profile.income === "mittel") chance += 0.05;
    if (state.stats.bildung >= 65) chance += 0.14;
    else if (state.stats.bildung >= 50) chance += 0.07;
    if (state.flags.kenntLehrkraft) chance += 0.08;
    if (state.flags.uebungDeutschAG) chance += 0.04;
    if (state.stats.sprache >= 60) chance += 0.05;
    if (state.flags.elternEngagement === "hoch") chance += 0.12;
    else if (state.flags.elternEngagement === "niedrig") chance -= 0.07;
    else if (state.flags.elternEngagement === "vernachlaessigt") chance -= 0.15;
    if (state.profile.wohnlage === "benachteiligte Lage") chance -= 0.05;
    chance = Math.min(Math.max(chance, 0.04), 0.88);
    const pct = Math.round(chance * 100);
    const ell = state.flags.elternAkademiker ? "Akademiker-Kind: +28%" : "Nicht-Akademiker-Kind: ¬±0%";
    const engLabel = { hoch: "+12%", mittel: "¬±0%", niedrig: "‚Äì7%", vernachlaessigt: "‚Äì15%" }[state.flags.elternEngagement] || "";
    gymBox.innerHTML = `
      <div class="gymchance-box">
        <div class="chance-title">üéì Deine Gymnasium-Chance: ${pct}%</div>
        <div class="gymchance-bar"><div style="width:${pct}%"></div></div>
        <div style="margin-top:8px; font-size:13px;">üë®‚Äçüë©‚Äçüëß ${ell} &nbsp;|&nbsp; ‚ù§Ô∏è Eltern-Engagement: ${engLabel}<br>Zum Vergleich: Mit Akademiker-Eltern liegt die Chance oft bei 60‚Äì80%, ohne bei 10‚Äì25%.</div>
      </div>`;
  }

  // Reflexion
  const refEl = el("reflection");
  if (sc.reflection) {
    refEl.textContent = sc.reflection;
    refEl.style.display = "block";
  } else {
    refEl.style.display = "none";
  }

  // Ergebnis-Box bei result
  const choices = el("choices");
  choices.innerHTML = "";

  if (state.currentScene === "result") {
    const out = computeOutcome(state);

    const box = document.createElement("div");
    box.className = "outcome-box " + out.kind;
    box.textContent = out.label;
    choices.appendChild(box);

    // Score bar mit Maximum
    const scoreDiv = document.createElement("div");
    scoreDiv.style.cssText = "margin-top:12px; padding:14px; border-radius:14px; border:1px solid var(--border); background:rgba(0,0,0,.12);";
    const scoreRounded = Math.round(out.score);
    const maxRounded = Math.round(out.maxScore);
    const barColor = out.kind === "ok" ? "rgba(113,247,183,.8)" : out.kind === "warn" ? "rgba(255,209,102,.8)" : "rgba(255,107,107,.8)";
    scoreDiv.innerHTML = `
      <div style="display:flex; justify-content:space-between; font-size:13px; color:var(--muted); margin-bottom:6px;">
        <span>üìä Dein Bildungspfad-Score</span>
        <span style="color:var(--text); font-weight:700">${scoreRounded} / ${maxRounded} Pkt. (${out.pct}%)</span>
      </div>
      <div style="height:12px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden;">
        <div style="height:100%; width:${out.pct}%; background:${barColor}; border-radius:999px; transition:width .4s ease;"></div>
      </div>
      <div style="margin-top:8px; font-size:12px; color:var(--muted);">Maximum: ${maxRounded} Punkte (Bildung, Sprache, Sozial, Geld je 100 ‚Äì Stress 0)</div>
    `;
    choices.appendChild(scoreDiv);

    // Noten
    const grades = [];
    if (state.flags.noteGrundschule !== null) grades.push("Grundschule: √ò " + state.flags.noteGrundschule.toFixed(1));
    if (state.flags.noteSek1 !== null) grades.push("Sek I: √ò " + state.flags.noteSek1.toFixed(1));
    if (grades.length) {
      const gradeDiv = document.createElement("div");
      gradeDiv.style.cssText = "margin-top:10px; padding:12px 14px; border-radius:14px; border:1px solid rgba(110,231,255,.25); background:rgba(110,231,255,.06); color:var(--accent); font-size:14px;";
      gradeDiv.innerHTML = "<b>üìù Deine Noten:</b><br>" + grades.join(" &nbsp;|&nbsp; ");
      choices.appendChild(gradeDiv);
    }

    // Achievements
    const earned = state.flags.achievements || [];
    if (earned.length) {
      const achDiv = document.createElement("div");
      achDiv.style.cssText = "margin-top:10px; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,209,102,.25); background:rgba(255,209,102,.06); font-size:14px;";
      achDiv.innerHTML = "<b style='color:var(--warn)'>üèÖ Deine Achievements:</b><br><div style='margin-top:6px; display:flex; flex-wrap:wrap; gap:6px'>" +
        earned.map(a => `<span style='background:rgba(255,255,255,.07); border:1px solid var(--border); border-radius:8px; padding:4px 9px; font-size:13px'>${a}</span>`).join("") +
        "</div>";
      choices.appendChild(achDiv);
    }

    const spacer = document.createElement("div");
    spacer.style.height = "12px";
    choices.appendChild(spacer);
  }

  // Anzahl Choices bestimmt Layout
  const choiceCount = sc.choices.length;
  if (choiceCount <= 2) {
    choices.classList.add("single-col");
  } else {
    choices.classList.remove("single-col");
  }

  for (const ch of sc.choices){
    const btn = document.createElement("button");
    // "Weiter"-Buttons und Ergebnis-Buttons immer volle Breite
    const isFullWidth = ch.label.startsWith("‚û°Ô∏è") || ch.label.startsWith("üìà") || 
                        ch.label.startsWith("üîÑ") || ch.label.startsWith("‚ùì") ||
                        ch.label.startsWith("üèÅ") || choiceCount <= 2;
    btn.className = "btn" + (isFullWidth ? " btn-full" : "");
    let locked = false;
    if (typeof ch.requires === "function"){
      locked = !ch.requires(state);
    }
    btn.disabled = locked;
    btn.innerHTML = `
      <div>${escapeHTML(ch.label)}</div>
      ${ch.note ? `<div class="tag">üí¨ ${escapeHTML(ch.note)}</div>` : ``}
      ${locked ? `<span class="lock">${escapeHTML(ch.lockReason || "‚õî Voraussetzung nicht erf√ºllt.")}</span>` : ``}
    `;
    btn.addEventListener("click", () => {
      playClick();
      if (ch.next === "__NEW__"){ gotoScene("__NEW__"); return; }
      if (ch.effects){
        applyEffects(state, ch.effects);
        if (ch.label && !ch.label.startsWith("‚û°Ô∏è")) pushLog(state, sc.title, "Entscheidung: " + ch.label);
      }
      checkAchievements(state);
      saveLocal();
      gotoScene(ch.next);
    });
    choices.appendChild(btn);
  }
}

function renderGrade(){
  const gv = el("gradeVal");
  const gd = el("gradeDesc");
  const gb = el("gradeBox");
  let grade = null;
  let label = "";
  if (state.flags.noteSek1 !== null) {
    grade = state.flags.noteSek1;
    label = "Sek I";
  } else if (state.flags.noteGrundschule !== null) {
    grade = state.flags.noteGrundschule;
    label = "Grundschule";
  }
  if (grade !== null) {
    gv.textContent = grade.toFixed(1);
    gd.textContent = gradeDescription(grade) + (label ? ` (${label})` : "");
    // Farbe je nach Note
    if (grade <= 2.5) gb.style.borderColor = "rgba(113,247,183,.35)";
    else if (grade <= 3.5) gb.style.borderColor = "rgba(110,231,255,.35)";
    else if (grade <= 4.5) gb.style.borderColor = "rgba(255,209,102,.35)";
    else gb.style.borderColor = "rgba(255,107,107,.35)";
  } else {
    gv.textContent = "‚Äì";
    gd.textContent = "Noch keine Noten";
  }
}

function showEventOverlay(ev){
  // Remove existing overlay if any
  const existing = document.getElementById("eventOverlay");
  if (existing) existing.remove();

  const overlay = document.createElement("div");
  overlay.className = "event-overlay";
  overlay.id = "eventOverlay";

  const effectsHTML = ev.effectLabels.map(e =>
    `<div class="effect-row ${e.kind}">${e.text}</div>`
  ).join("");

  overlay.innerHTML = `
    <div class="event-card">
      <div class="event-icon">${ev.icon}</div>
      <div class="event-title">‚ö° Zufallsereignis: ${ev.title}</div>
      <div class="event-text">${ev.text}</div>
      <div class="event-effects">${effectsHTML}</div>
      <button class="event-btn" id="eventDismiss">‚úì Verstanden ‚Äì weiter!</button>
    </div>
  `;
  document.body.appendChild(overlay);

  document.getElementById("eventDismiss").addEventListener("click", () => {
    // Apply effects
    ev.effects(state);
    normalizeStats(state);
    pushLog(state, "‚ö° " + ev.title, ev.text.split(".")[0] + ".");
    saveLocal();
    overlay.remove();
    pendingEvent = null;
    render();
  });
}

function render(){
  renderPills();
  renderMeta();
  renderStats();
  renderGrade();
  renderLog();
  renderScene();
  renderProgressBarAndButtons();
  // Show event overlay after render if pending
  if (pendingEvent) {
    showEventOverlay(pendingEvent);
    pendingEvent = null;
  }
}

// ---------- Safety: basic escaping ----------
function escapeHTML(str){
  return String(str ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    '"':"&quot;",
    "'":"&#039;"
  }[m]));
}

// ---------- Click Sound ----------
function playClick() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.type = "sine";
    osc.frequency.setValueAtTime(440, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.06);
    gain.gain.setValueAtTime(0.08, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.12);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.13);
  } catch(e) { /* Audio nicht verf√ºgbar */ }
}

// ---------- Theme Toggle ----------
let isLightMode = localStorage.getItem("planspiel_theme") === "light";
function applyTheme() {
  if (isLightMode) {
    document.body.classList.add("light-mode");
    el("btnTheme").textContent = "‚òÄÔ∏è Hell";
  } else {
    document.body.classList.remove("light-mode");
    el("btnTheme").textContent = "üåô Dunkel";
  }
}

// ---------- Achievements ----------
const ACHIEVEMENT_DEFS = [
  { id: "ach_gym",      label: "üéì Gymnasiast:in",        check: (s) => s.flags.gymnasiumErreicht },
  { id: "ach_laptop",   label: "üíª Digital-Profi",         check: (s) => s.flags.hatLaptop },
  { id: "ach_foerder",  label: "üìã Gut vernetzt",           check: (s) => s.flags.hatFoerderung && s.flags.kenntLehrkraft },
  { id: "ach_ag",       label: "üó£Ô∏è Sprachtalent",           check: (s) => s.flags.uebungDeutschAG && s.stats.sprache >= 65 },
  { id: "ach_eingeschult", label: "üéí Eingeschult",         check: (s) => s.age >= 7 },
  { id: "ach_bildung",  label: "üìö Wissenshungrig",         check: (s) => s.stats.bildung >= 75 },
  { id: "ach_sozial",   label: "ü§ù Netzwerker:in",          check: (s) => s.stats.sozial >= 70 },
  { id: "ach_praktikum",label: "üîç Praktikum-Champion",     check: (s) => s.log.some(l => l.title === "Praktikum" && l.text.includes("findest")) },
  { id: "ach_trotzdem", label: "üí™ Trotz allem weiter",      check: (s) => s.stats.stress >= 60 && s.stats.bildung >= 45 },
  { id: "ach_armut",    label: "üå± Trotz Armut ans Gym",    check: (s) => s.profile.income === "niedrig" && s.flags.gymnasiumErreicht },
  { id: "ach_18",       label: "üéÇ Vollj√§hrig!",            check: (s) => s.age >= 18 },
  { id: "ach_auto",     label: "üöó F√ºhrerschein gemacht",   check: (s) => s.flags.hatFuehrerschein === true },
];

function checkAchievements(s) {
  if (!s.flags.achievements) s.flags.achievements = [];
  for (const def of ACHIEVEMENT_DEFS) {
    if (!s.flags.achievements.includes(def.label) && def.check(s)) {
      s.flags.achievements.push(def.label);
      showAchievementToast(def.label);
    }
  }
}

function showAchievementToast(label) {
  // Remove any existing toast
  const old = document.getElementById("achToast");
  if (old) old.remove();

  const toast = document.createElement("div");
  toast.className = "ach-toast";
  toast.id = "achToast";
  toast.textContent = "üèÖ Achievement freigeschaltet: " + label;
  document.body.appendChild(toast);

  // Play achievement sound
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    [523, 659, 784, 1047].forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.frequency.value = freq;
      osc.type = "sine";
      gain.gain.setValueAtTime(0.07, ctx.currentTime + i * 0.1);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.1 + 0.15);
      osc.start(ctx.currentTime + i * 0.1);
      osc.stop(ctx.currentTime + i * 0.1 + 0.2);
    });
  } catch(e) {}

  requestAnimationFrame(() => {
    requestAnimationFrame(() => { toast.classList.add("show"); });
  });
  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 400);
  }, 3000);
}

// ---------- Fortschrittsbalken ----------
const SCENE_ORDER = [
  "intro","klassenfahrt","hausaufgaben","deutsch_ag",
  "alltag_handy","alltag_ernaehrung","alltag_freizeit","alltag_schlaf","alltag_arzt",
  "uebergang","gymnasium_entscheidung","gymnasium_ergebnis",
  "sek1_digital","praktikum",
  "sek1_konsum","sek1_fuehrerschein","sek1_zukunft",
  "abschluss","result"
];

const PROGRESS_MILESTONES = [
  { pct: 0,   label: "üéí", tip: "Einschulung (6 J.)" },
  { pct: 28,  label: "üìñ", tip: "Grundschule (8‚Äì10 J.)" },
  { pct: 55,  label: "üè´", tip: "√úbergang Sek I (10 J.)" },
  { pct: 75,  label: "üíº", tip: "Mittelstufe (13‚Äì15 J.)" },
  { pct: 90,  label: "üéì", tip: "Oberstufe (16‚Äì18 J.)" },
  { pct: 100, label: "üèÅ", tip: "Abschluss (18 J.)" },
];

function renderProgressBar() {
  const idx = SCENE_ORDER.indexOf(state.currentScene);
  const total = SCENE_ORDER.length - 1;
  const pct = idx < 0 ? 0 : Math.round((idx / total) * 100);

  const fill = el("progressFill");
  fill.style.width = pct + "%";

  const track = el("progressTrack");
  // Remove old dots
  track.querySelectorAll(".progress-dot").forEach(d => d.remove());

  PROGRESS_MILESTONES.forEach(m => {
    const dot = document.createElement("div");
    dot.className = "progress-dot" + (pct >= m.pct ? " done" : "") + (Math.abs(pct - m.pct) < 8 ? " active" : "");
    dot.style.left = m.pct + "%";
    dot.title = m.tip;
    dot.textContent = m.label;
    dot.style.fontSize = "9px";
    track.appendChild(dot);
  });
}

// ---------- Profilkarte ----------
function showProfileCard() {
  const existing = document.getElementById("profileOverlay");
  if (existing) existing.remove();

  const engMap = {
    hoch:            { label: "‚ù§Ô∏è Sehr engagiert", desc: "Deine Eltern k√ºmmern sich aktiv um deine Schule und deinen Alltag." },
    mittel:          { label: "üôÇ Mittel engagiert", desc: "Deine Eltern sind da ‚Äì aber oft besch√§ftigt oder unsicher wie sie helfen k√∂nnen." },
    niedrig:         { label: "üòê Wenig Zeit",  desc: "Deine Eltern sind √ºberlastet. Du musst vieles selbst regeln." },
    vernachlaessigt: { label: "üòî Kaum vorhanden", desc: "Du bist oft auf dich allein gestellt. Das ist sehr schwer." }
  };
  const eng = engMap[state.flags.elternEngagement] || engMap.mittel;

  const incomeEmoji = { hoch: "üí∞üí∞", mittel: "üí∞", niedrig: "ü™ô" };
  const regionEmoji = { "Gro√üstadt": "üèôÔ∏è", "Mittelstadt": "üèòÔ∏è", "L√§ndlicher Raum": "üåæ" };
  const familyEmoji = { "2 Elternteile": "üë®‚Äçüë©‚Äçüëß", "alleinerziehend": "üßë‚Äçüëß", "Patchwork": "üë™" };

  const overlay = document.createElement("div");
  overlay.className = "profile-overlay";
  overlay.id = "profileOverlay";
  overlay.innerHTML = `
    <div class="profile-card">
      <div class="pc-title">Dein zuf√§lliges Profil ‚Äì wie im echten Leben</div>
      <div class="pc-headline">üë§ Du bist ein Kind aus ${escapeHTML(state.profile.region || "Deutschland")}</div>
      <div class="pc-grid">
        <div class="pc-item">
          <div class="pc-label">üìç Region</div>
          <div class="pc-val">${regionEmoji[state.profile.region] || ""} ${escapeHTML(state.profile.region || "‚Äì")}</div>
        </div>
        <div class="pc-item">
          <div class="pc-label">üè† Wohnlage</div>
          <div class="pc-val">${escapeHTML(state.profile.wohnlage || "‚Äì")}</div>
        </div>
        <div class="pc-item">
          <div class="pc-label">üë®‚Äçüë©‚Äçüëß Familie</div>
          <div class="pc-val">${familyEmoji[state.profile.family] || ""} ${escapeHTML(state.profile.family || "‚Äì")}</div>
        </div>
        <div class="pc-item">
          <div class="pc-label">üí∂ Einkommen</div>
          <div class="pc-val">${incomeEmoji[state.profile.income] || ""} ${escapeHTML(state.profile.income || "‚Äì")}</div>
        </div>
        <div class="pc-item">
          <div class="pc-label">üó£Ô∏è Sprache zuhause</div>
          <div class="pc-val">${escapeHTML(state.profile.languageHome || "‚Äì")}</div>
        </div>
        <div class="pc-item">
          <div class="pc-label">üéì Eltern-Bildung</div>
          <div class="pc-val">${escapeHTML(state.profile.elternBildung || "‚Äì")}</div>
        </div>
      </div>
      <div class="pc-engagement ${state.flags.elternEngagement}">
        <b>${eng.label}</b><br>
        <span style="font-size:13px; opacity:.85">${eng.desc}</span>
      </div>
      <button class="pc-start-btn" id="pcStartBtn">üöÄ Los geht's ‚Äì Spiel starten!</button>
    </div>
  `;
  document.body.appendChild(overlay);

  document.getElementById("pcStartBtn").addEventListener("click", () => {
    playClick();
    overlay.remove();
    gotoScene("intro");
  });
}

// ---------- Was w√§re wenn ----------
function computeHypotheticalScore(overrides) {
  return simulateFullGame(overrides);
}

function showWhatIf() {
  const existing = document.getElementById("wwiwOverlay");
  if (existing) { existing.remove(); return; }

  const overlay = document.createElement("div");
  overlay.className = "wwiw-overlay";
  overlay.id = "wwiwOverlay";

  const currentOut = computeOutcome(state);

  overlay.innerHTML = `
    <div class="wwiw-card">
      <h3>üîÆ Was w√§re wenn‚Ä¶?</h3>
      <div class="wwiw-sub">Ver√§ndere Startbedingungen und sieh wie sich dein Score entwickelt h√§tte.</div>

      <div class="wwiw-row">
        <label>üí∂ Einkommen</label>
        <select id="ww-income">
          <option value="">‚Äì unver√§ndert ‚Äì</option>
          <option value="hoch">Hoch</option>
          <option value="mittel">Mittel</option>
          <option value="niedrig">Niedrig</option>
        </select>
      </div>
      <div class="wwiw-row">
        <label>üéì Eltern-Bildung</label>
        <select id="ww-bildung">
          <option value="">‚Äì unver√§ndert ‚Äì</option>
          <option value="Akademiker (Uni/FH)">Akademiker (Uni/FH)</option>
          <option value="Berufsausbildung">Berufsausbildung</option>
          <option value="ohne Abschluss">Ohne Abschluss</option>
        </select>
      </div>
      <div class="wwiw-row">
        <label>‚ù§Ô∏è Eltern-Engagement</label>
        <select id="ww-engagement">
          <option value="">‚Äì unver√§ndert ‚Äì</option>
          <option value="hoch">Sehr engagiert</option>
          <option value="mittel">Mittel</option>
          <option value="niedrig">Wenig Zeit</option>
          <option value="vernachlaessigt">Kaum vorhanden</option>
        </select>
      </div>
      <div class="wwiw-row">
        <label>üìç Region</label>
        <select id="ww-region">
          <option value="">‚Äì unver√§ndert ‚Äì</option>
          <option value="Gro√üstadt">Gro√üstadt</option>
          <option value="Mittelstadt">Mittelstadt</option>
          <option value="L√§ndlicher Raum">L√§ndlicher Raum</option>
        </select>
      </div>

      <div class="wwiw-result" id="wwiwResult">
        <div class="wwiw-score-row">
          <span>Dein echter Score:</span>
          <b>${Math.round(currentOut.score)} / ${Math.round(currentOut.maxScore)} Pkt. (${currentOut.pct}%)</b>
        </div>
        <div class="wwiw-score-row" id="wwiwHypoRow" style="display:none">
          <span>Hypothetischer Score:</span>
          <b id="wwiwHypoScore">‚Äì</b>
        </div>
        <div id="wwiwDiff" style="margin-top:8px; font-size:13px; color:var(--muted);">W√§hle oben eine Bedingung zum Vergleichen.</div>
      </div>

      <button class="wwiw-btn" id="wwiwCalcBtn">üîÆ Berechnen</button>
      <button class="wwiw-close" id="wwiwCloseBtn">‚úï Schlie√üen</button>
    </div>
  `;
  document.body.appendChild(overlay);

  document.getElementById("wwiwCalcBtn").addEventListener("click", () => {
    playClick();
    const overrides = {};
    const income = document.getElementById("ww-income").value;
    const bildung = document.getElementById("ww-bildung").value;
    const engagement = document.getElementById("ww-engagement").value;
    const region = document.getElementById("ww-region").value;
    if (income) overrides.income = income;
    if (bildung) overrides.elternBildung = bildung;
    if (engagement) overrides.elternEngagement = engagement;
    if (region) overrides.region = region;

    if (!Object.keys(overrides).length) {
      document.getElementById("wwiwDiff").textContent = "Bitte w√§hle mindestens eine Bedingung zum √Ñndern.";
      return;
    }

    const hypo = computeHypotheticalScore(overrides);
    const diff = hypo.score - Math.round(currentOut.score);
    const diffStr = (diff >= 0 ? "+" : "") + diff;
    const diffColor = diff > 8 ? "var(--ok)" : diff < -8 ? "var(--danger)" : "var(--warn)";

    document.getElementById("wwiwHypoRow").style.display = "flex";
    document.getElementById("wwiwHypoScore").textContent = `${hypo.score} / ${hypo.maxScore} Pkt. (${hypo.pct}%)`;

    let interpretation = "";
    if (diff > 20) interpretation = "üü¢ Mit diesen Bedingungen h√§ttest du deutlich bessere Chancen gehabt!";
    else if (diff > 8) interpretation = "üü° Diese Bedingungen h√§tten dir sp√ºrbar geholfen.";
    else if (diff < -20) interpretation = "üî¥ Mit diesen Bedingungen w√§re dein Weg noch viel schwerer gewesen.";
    else if (diff < -8) interpretation = "üü° Diese Bedingungen h√§tten dich merklich benachteiligt.";
    else interpretation = "‚ö™ Der Unterschied w√§re gering gewesen.";

    document.getElementById("wwiwDiff").innerHTML = `
      <span style="color:${diffColor}; font-weight:700; font-size:16px;">${diffStr} Punkte Unterschied</span><br>
      <span style="margin-top:4px; display:block; color:var(--muted)">${interpretation}</span>
      <div style="margin-top:8px; font-size:12px; color:var(--muted);">
        üéì Gymnasium-Wahrscheinlichkeit (simuliert): <b style="color:var(--text)">${hypo.gymChance}%</b>
        ${hypo.gymChance !== undefined ? ` vs. aktuell: <b style="color:var(--text)">${state.flags.lastGymChance || "?"}%</b>` : ""}
      </div>
    `;
  });

  document.getElementById("wwiwCloseBtn").addEventListener("click", () => {
    playClick();
    overlay.remove();
  });
}

// ---------- QR-Code: Ergebniskarte als Canvas (offline, kein API) ----------
function buildResultCanvas(canvas) {
  const out = computeOutcome(state);
  const grades = [];
  if (state.flags.noteGrundschule) grades.push("GS √ò" + state.flags.noteGrundschule.toFixed(1));
  if (state.flags.noteSek1) grades.push("Sek √ò" + state.flags.noteSek1.toFixed(1));
  const ach = (state.flags.achievements || []).length;

  const W = 320, H = 330;
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext("2d");

  // Hintergrund
  ctx.fillStyle = "#0b1020";
  ctx.fillRect(0, 0, W, H);

  // Rahmen
  ctx.strokeStyle = "rgba(110,231,255,0.45)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  if (ctx.roundRect) ctx.roundRect(4, 4, W-8, H-8, 14);
  else ctx.rect(4, 4, W-8, H-8);
  ctx.stroke();

  // Titelzeile
  ctx.fillStyle = "rgba(110,231,255,0.12)";
  ctx.fillRect(4, 4, W-8, 44);
  ctx.fillStyle = "#6ee7ff";
  ctx.font = "bold 14px sans-serif";
  ctx.textAlign = "center";
  ctx.fillText("üéÆ Dein Weg ‚Äì Bildungsergebnis", W/2, 30);

  // Score-Balken
  const barY = 60;
  ctx.fillStyle = "rgba(255,255,255,0.07)";
  ctx.fillRect(16, barY, W-32, 26);
  const barColor = out.kind === "ok" ? "#71f7b7" : out.kind === "warn" ? "#ffd166" : "#ff6b6b";
  ctx.fillStyle = barColor;
  ctx.fillRect(16, barY, Math.round((W-32) * out.pct / 100), 26);
  ctx.fillStyle = "#0b1020";
  ctx.font = "bold 12px sans-serif";
  ctx.textAlign = "center";
  ctx.fillText("Score: " + Math.round(out.score) + " / 85 Pkt. (" + out.pct + "%)", W/2, barY + 17);

  // Datenspalten
  const rows = [
    ["üéì Gymnasium", state.flags.gymnasiumErreicht ? "Ja ‚úÖ" : "Nein ‚ùå"],
    ["üìù Noten", grades.length ? grades.join(" | ") : "‚Äì"],
    ["üèÖ Achievements", ach + " freigeschaltet"],
    ["üí∞ Einkommen", state.profile.income || "‚Äì"],
    ["üéì Elternbildung", (state.profile.elternBildung||"‚Äì").replace("Akademiker (Uni/FH)","Akademiker")],
    ["‚ù§Ô∏è Engagement", ({hoch:"Sehr hoch",mittel:"Mittel",niedrig:"Wenig",vernachlaessigt:"Kaum"})[state.flags.elternEngagement] || "‚Äì"],
    ["üó∫Ô∏è Region", state.profile.region || "‚Äì"],
  ];
  rows.forEach(([label, value], i) => {
    const y = 100 + i * 29;
    ctx.fillStyle = i % 2 === 0 ? "rgba(255,255,255,0.04)" : "transparent";
    ctx.fillRect(12, y, W-24, 26);
    ctx.fillStyle = "rgba(170,179,218,0.85)";
    ctx.font = "11px sans-serif";
    ctx.textAlign = "left";
    ctx.fillText(label, 20, y + 17);
    ctx.fillStyle = "#e8ecff";
    ctx.font = "bold 11px sans-serif";
    ctx.textAlign = "right";
    ctx.fillText(value, W-20, y + 17);
  });

  // Fu√üzeile
  ctx.fillStyle = "rgba(110,231,255,0.45)";
  ctx.font = "10px sans-serif";
  ctx.textAlign = "center";
  ctx.fillText("Screenshot machen & mit der Klasse vergleichen!", W/2, H - 10);
}

async function showQR() {
  const existing = document.getElementById("qrOverlay");
  if (existing) { existing.remove(); return; }

  const out = computeOutcome(state);
  const grades = [];
  if (state.flags.noteGrundschule) grades.push("GS √ò" + state.flags.noteGrundschule.toFixed(1));
  if (state.flags.noteSek1) grades.push("Sek √ò" + state.flags.noteSek1.toFixed(1));
  const ach = (state.flags.achievements || []).length;
  const gymText = state.flags.gymnasiumErreicht ? "‚úÖ Erreicht" : "‚ùå Nicht erreicht";
  const engLabel = ({hoch:"Sehr engagiert",mittel:"Mittel",niedrig:"Wenig Zeit",vernachlaessigt:"Kaum vorhanden"})[state.flags.elternEngagement] || "";

  const overlay = document.createElement("div");
  overlay.className = "qr-overlay";
  overlay.id = "qrOverlay";
  overlay.innerHTML = `
    <div class="qr-card">
      <h3>üì≤ Ergebnis teilen</h3>
      <div class="qr-sub">Mach einen Screenshot der Ergebniskarte und zeig sie in der Klasse ‚Äì vergleicht eure unterschiedlichen Wege!</div>
      <canvas id="resultCanvas" style="border-radius:10px; display:block; margin:0 auto 14px; max-width:100%; image-rendering:pixelated;"></canvas>
      <div class="qr-summary">
        <b style="color:var(--ok)">Dein Ergebnis auf einen Blick:</b><br>
        üìä <b>${Math.round(out.score)} / 85 Pkt. (${out.pct}%)</b> &nbsp;|&nbsp; üéì Gymnasium: ${gymText}<br>
        ${grades.length ? "üìù " + grades.join(" | ") + "<br>" : ""}
        üèÖ ${ach} Achievement(s) &nbsp;|&nbsp; ‚ù§Ô∏è ${escapeHTML(engLabel)}<br>
        üë§ ${escapeHTML(state.profile.income||"")} ¬∑ ${escapeHTML((state.profile.elternBildung||"").replace("Akademiker (Uni/FH)","Akademiker"))} ¬∑ ${escapeHTML(state.profile.region||"")}
      </div>
      <button class="qr-close" id="qrCloseBtn">‚úï Schlie√üen</button>
    </div>
  `;
  document.body.appendChild(overlay);
  buildResultCanvas(document.getElementById("resultCanvas"));
  document.getElementById("qrCloseBtn").addEventListener("click", () => { playClick(); overlay.remove(); });
}

// ---------- Was w√§re wenn: vollst√§ndige Spielsimulation ----------
// Simuliert den ganzen Spielverlauf deterministisch mit den g√ºnstigsten
// verf√ºgbaren Entscheidungen ‚Äì Geld wird nicht als laufender Wert,
// sondern als Einkommens-Klasse (reich/mittel/arm) gef√ºhrt.
function simulateFullGame(overrides) {
  const inc  = overrides.income          || state.profile.income          || "mittel";
  const eb   = overrides.elternBildung   || state.profile.elternBildung   || "Berufsausbildung";
  const lang = overrides.languageHome    || state.profile.languageHome    || "Deutsch";
  const reg  = overrides.region          || state.profile.region          || "Mittelstadt";
  const wohn = overrides.wohnlage        || state.profile.wohnlage        || "durchschnittliche Lage";
  const eng  = overrides.elternEngagement || state.flags.elternEngagement || "mittel";

  let bildung = 40, sprache = 50, sozial = 40, stress = 20;
  let akademiker = false, foerderung = false, uebungAG = false, kenntLehrer = false;

  const reich = inc === "hoch", mittel = inc === "mittel", arm = inc === "niedrig";

  // Startwerte
  if (lang === "Deutsch") sprache = 65;
  else if (lang === "Deutsch & andere Sprache") sprache = 55;
  else sprache = 38;

  if (wohn === "gute Lage") { sozial += 8; stress -= 5; }
  else if (wohn === "benachteiligte Lage") { sozial -= 7; stress += 7; }

  if (eb === "Akademiker (Uni/FH)") { bildung += 12; sozial += 10; akademiker = true; }
  else if (eb === "Berufsausbildung") { bildung += 4; sozial += 3; }
  else { bildung -= 5; stress += 5; }

  if (reg === "Gro√üstadt" || reg === "Mittelstadt") foerderung = true;

  // Klassenfahrt
  if (reich || mittel) { sozial += 10; stress -= 3; }
  else if (foerderung) { sozial += 6; stress += 2; }
  else { sozial -= 8; stress += 5; }

  // Hausaufgaben
  if (eng === "hoch" && lang !== "vorwiegend andere Sprache") { bildung += 10; stress -= 3; }
  else if (reich || mittel) { bildung += 12; stress -= 2; }
  else if (eng !== "vernachlaessigt") { bildung += 6; stress += 2; }
  else { bildung -= 4; stress += 8; }

  // Deutsch-AG
  if (eng !== "vernachlaessigt") { sprache += 10; bildung += 4; uebungAG = true; }

  // Handy
  if (arm && !foerderung) { stress += 5; sozial -= 4; }
  else if (akademiker) { bildung += 4; stress -= 2; }
  else { sozial += 2; }

  // Essen
  if (eng === "vernachlaessigt") { stress += 8; bildung -= 5; sozial -= 3; }
  else if (arm) { bildung += 3; stress -= 2; }   // Bildungspaket
  else { bildung += 2; stress -= 2; }

  // Freizeit
  if (reich) { sozial += 8; stress -= 5; bildung += 2; }
  else if (reg !== "L√§ndlicher Raum") { sozial += 4; stress -= 2; }
  else { sozial -= 3; stress += 3; }

  // Schlaf
  if (wohn === "gute Lage") { stress -= 8; bildung += 4; }
  else if (arm || eng === "vernachlaessigt") { stress += 9; bildung -= 5; sozial -= 2; }
  else { stress += 2; bildung += 1; }

  // Arzt
  if (reich || akademiker) { bildung += 6; stress -= 4; }
  else if (mittel) { stress += 3; bildung += 1; }
  else { stress += 7; bildung -= 8; }

  // √úbergang
  if ((eng === "hoch" || eng === "mittel") && (reich || mittel)) {
    sozial += 6; bildung += 3; kenntLehrer = true;
  } else if (sprache >= 48) { sozial += 3; kenntLehrer = true; }
  else { stress += 3; sozial -= 2; }

  // Gymnasium-Chance
  let gymChance = 0.15;
  if (akademiker) gymChance += 0.28;
  if (reich) gymChance += 0.12; else if (mittel) gymChance += 0.05;
  if (bildung >= 65) gymChance += 0.14; else if (bildung >= 50) gymChance += 0.07;
  if (kenntLehrer) gymChance += 0.08;
  if (uebungAG) gymChance += 0.04;
  if (sprache >= 60) gymChance += 0.05;
  if (eng === "hoch") gymChance += 0.12;
  else if (eng === "niedrig") gymChance -= 0.07;
  else if (eng === "vernachlaessigt") gymChance -= 0.15;
  if (wohn === "benachteiligte Lage") gymChance -= 0.05;
  gymChance = Math.min(Math.max(gymChance, 0.04), 0.88);
  const gymnasium = gymChance > 0.5;
  if (gymnasium) { bildung += 6; sozial += 5; } else { stress += 5; }

  // Sek I Digital
  if (reich || mittel) { bildung += 8; stress -= 2; } else { bildung -= 2; stress += 7; }

  // Praktikum
  if (sozial >= 55 || akademiker) { sozial += 6; bildung += 4; stress -= 2; }
  else { bildung += 2; stress += 3; }

  // Konsum / Marken
  if (reich) { sozial += 7; stress -= 4; }
  else if (sozial >= 50) { bildung += 3; stress += 2; }
  else { sozial -= 8; stress += 9; }

  // F√ºhrerschein
  if (reich) { sozial += 10; stress -= 6; }
  else if (mittel) { sozial += 5; stress -= 3; }
  else if (reg === "L√§ndlicher Raum") { stress += 8; sozial -= 5; }
  else { stress += 3; sozial -= 2; }

  // Zukunft
  if (gymnasium && bildung >= 55) { bildung += 8; stress += 5; sozial += 4; }
  else { bildung += 5; stress += 3; }

  // Normalisieren
  const cl = v => Math.max(0, Math.min(100, v));
  bildung = cl(bildung); sprache = cl(sprache); sozial = cl(sozial); stress = cl(stress);
  const geld = reich ? 72 : mittel ? 42 : 18;

  const score = 0.40*bildung + 0.20*sprache + 0.15*sozial + 0.10*geld - 0.25*stress;
  const maxScore = 85;
  const pct = Math.round((Math.max(0, score) / maxScore) * 100);
  return { score: Math.round(score), pct, maxScore, gymChance: Math.round(gymChance * 100) };
}

// ---------- Render-Erweiterungen ----------
function renderProgressBarAndButtons() {
  renderProgressBar();
  // "Was w√§re wenn" und "QR teilen" nur am Ende sichtbar
  const isEnd = ["result","abschluss"].includes(state.currentScene);
  el("btnWhatIf").style.display = isEnd ? "inline-flex" : "none";
  el("btnQR").style.display = isEnd ? "inline-flex" : "none";
}

// ---------- Anleitung / How to Play ----------
function showHelp() {
  const existing = document.getElementById("helpOverlay");
  if (existing) { existing.remove(); return; }

  const overlay = document.createElement("div");
  overlay.className = "help-overlay";
  overlay.id = "helpOverlay";
  overlay.innerHTML = `
    <div class="help-card">
      <h3>‚ùì So funktioniert das Spiel</h3>
      <div class="help-sub">Ein Planspiel √ºber Bildung und soziale Gerechtigkeit in Deutschland ‚Äì f√ºr den Einsatz im Unterricht.</div>

      <div class="help-section">
        <h4>üéØ Was ist das Ziel?</h4>
        <p>Du schl√ºpfst in die Rolle eines Kindes mit einem <b>zuf√§llig bestimmten Startprofil</b> ‚Äì genau wie im echten Leben. Du triffst Entscheidungen und erlebst, wie Herkunft, Einkommen und Umfeld deinen Bildungsweg beeinflussen.</p>
        <p>Am Ende siehst du deinen Score und kannst mit Mitsch√ºler:innen vergleichen: Warum haben manche bessere Chancen ‚Äì obwohl sie sich genauso bem√ºhen?</p>
      </div>

      <div class="help-section">
        <h4>üìä Deine vier Werte</h4>
        <div class="help-stat-row">
          <div class="help-stat"><span class="hs-icon">üìö</span><span class="hs-name">Bildung</span><span class="hs-desc">Wissen & Schulleistung</span></div>
          <div class="help-stat"><span class="hs-icon">üó£Ô∏è</span><span class="hs-name">Sprache</span><span class="hs-desc">Deutsch¬≠kenntnisse</span></div>
          <div class="help-stat"><span class="hs-icon">ü§ù</span><span class="hs-name">Sozial</span><span class="hs-desc">Kontakte & Netzwerk</span></div>
          <div class="help-stat"><span class="hs-icon">üò∞</span><span class="hs-name">Stress</span><span class="hs-desc">Belastung (weniger = besser)</span></div>
        </div>
      </div>

      <div class="help-section">
        <h4>üîí Gesperrte Optionen</h4>
        <p>Manche Entscheidungen sind f√ºr dein Profil <b>gesperrt</b> ‚Äì weil das Geld fehlt, die Sprache nicht reicht oder die Eltern nicht helfen k√∂nnen. Das ist kein Fehler, das ist die Realit√§t.</p>
        <p>Nur wer die Voraussetzungen erf√ºllt, kann die Chance nutzen.</p>
      </div>

      <div class="help-section">
        <h4>‚ö° Automatische Szenen</h4>
        <p>Manche Szenen (z. B. Mittagessen, Zimmer, Handy) haben <b>keine Wahlm√∂glichkeit</b>. Das Ergebnis ergibt sich aus deinem Profil ‚Äì denn nicht alle Kinder k√∂nnen w√§hlen.</p>
      </div>

      <div class="help-section">
        <h4>üé≤ Zufallsereignisse</h4>
        <p>Manchmal passieren unvorhergesehene Dinge ‚Äì Krankheit, Umzug, Stipendium. Das Leben ist kein vorhersehbarer Pfad.</p>
      </div>

      <div class="help-section">
        <h4>üèÅ Am Ende</h4>
        <p>Du erh√§ltst einen <b>Score von 0‚Äì85 Punkten</b> und kannst mit dem <b>üîÆ Was-w√§re-wenn-Modus</b> simulieren, was bei besseren oder schlechteren Startbedingungen passiert w√§re.</p>
        <p>Mit <b>üì≤ Ergebnis teilen</b> kannst du eine Ergebniskarte erstellen und sie in der Klasse zeigen.</p>
      </div>

      <button class="help-close" id="helpCloseBtn">‚úì Verstanden ‚Äì los geht's!</button>
    </div>
  `;
  document.body.appendChild(overlay);
  document.getElementById("helpCloseBtn").addEventListener("click", () => { playClick(); overlay.remove(); });
}

// ---------- Wire up buttons ----------
document.getElementById("btnNew").addEventListener("click", () => {
  playClick();
  state = rollStartState();
  saveLocal();
  showProfileCard();
});
document.getElementById("btnReset").addEventListener("click", () => { playClick(); resetAll(); });
document.getElementById("btnTheme").addEventListener("click", () => {
  isLightMode = !isLightMode;
  localStorage.setItem("planspiel_theme", isLightMode ? "light" : "dark");
  applyTheme();
  playClick();
});
document.getElementById("btnHelp").addEventListener("click", () => { playClick(); showHelp(); });
document.getElementById("btnQR").addEventListener("click", () => { playClick(); showQR(); });

// ---------- Init ----------
applyTheme();
state = loadLocal() || rollStartState();
if (!SCENES[state.currentScene]) state.currentScene = "intro";
render();
// Beim allerersten Start Profilkarte zeigen
if (state.currentScene === "intro" && !state.log.find(l => l.title !== "Spielstart")) {
  showProfileCard();
}
</script>
</body>
</html>
